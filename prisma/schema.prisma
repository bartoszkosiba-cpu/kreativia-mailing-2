datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model VirtualSalesperson {
  id          Int       @id @default(autoincrement())
  name        String    // np. "Marta ≈ª√≥≈Çkowska"
  email       String    @unique // Email g≈Ç√≥wny (dla referencji)
  phone       String?   // nr telefonu
  language    String    @default("pl") // pl, en, de, fr
  markets     String?   // np. "Polska, Niemcy" - rynki na kt√≥re mo≈ºe wysy≈Çaƒá
  
  // G≈Ç√≥wna skrzynka mailowa (u≈ºywana jako pierwsza w round-robin)
  mainMailboxId Int?    // ID skrzynki g≈Ç√≥wnej
  mainMailbox   Mailbox? @relation("MainMailbox", fields: [mainMailboxId], references: [id])
  
  // SMTP settings - DEPRECATED (u≈ºywaj Mailbox)
  smtpHost    String?   // np. "bartgrafic.home.pl"
  smtpPort    Int?      // np. 587
  smtpUser    String?   // login SMTP
  smtpPass    String?   // has≈Ço SMTP
  smtpSecure  Boolean   @default(false) // true = SSL (465), false = TLS (587)
  
  // IMAP settings - DEPRECATED (u≈ºywaj Mailbox)
  imapHost    String?   // np. "bartgrafic.home.pl"
  imapPort    Int?      // np. 993 lub 143
  imapUser    String?   // login IMAP (czƒôsto ten sam co SMTP)
  imapPass    String?   // has≈Ço IMAP (czƒôsto to samo co SMTP)
  imapSecure  Boolean   @default(true) // true = SSL (993), false = TLS (143)
  
  // Limity wysy≈Çki - DEPRECATED (u≈ºywaj Mailbox)
  dailyEmailLimit     Int       @default(150) // Max maili dziennie dla tego handlowca
  currentDailySent    Int       @default(0)   // Ile wys≈Çano dzisiaj
  lastResetDate       DateTime? // Kiedy ostatnio zresetowano licznik
  
  // Prawdziwy handlowiec (dla forwardowania zainteresowanych lead√≥w)
  realSalespersonEmail String?  // Email prawdziwego handlowca
  realSalespersonName  String?  // Imiƒô i nazwisko prawdziwego handlowca
  
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  campaigns   Campaign[]
  mailboxes   Mailbox[]  // NOWE: Wiele skrzynek mailowych dla tego handlowca
}

model Campaign {
  id          Int       @id @default(autoincrement())
  name        String
  description String?
  subject     String?   // Temat maila
  text        String?   // Tekst kampanii z ChatGPT
  jobDescription String? // Opis stanowiska pod imieniem handlowca
  postscript  String?   // PS. na ko≈Ñcu
  linkText    String?   // Tekst wy≈õwietlany linku (np. "Visit our site: www.kreativia.eu")
  linkUrl     String?   // URL docelowy (opcjonalny, je≈õli pusty u≈ºywa linkText jako URL)
  gmailLabel  String?
  dailyLimit  Int       @default(200)
  virtualSalespersonId Int?
  virtualSalesperson   VirtualSalesperson? @relation(fields: [virtualSalespersonId], references: [id])
  
  // AI Content Planner
  contentVersionId     Int?      // DEPRECATED - stara wersja
  contentVersion       CampaignVersion? @relation(fields: [contentVersionId], references: [id])
  savedContentId       Int?      // NOWE: Z kt√≥rego SavedContent pochodzi tre≈õƒá
  savedContent         SavedContent? @relation(fields: [savedContentId], references: [id])
  
  // Harmonogram wysy≈Çki
  status              String    @default("DRAFT") // DRAFT, SCHEDULED, IN_PROGRESS, COMPLETED, PAUSED, CANCELLED
  scheduledAt         DateTime? // Kiedy wys≈Çaƒá kampaniƒô
  sendingStartedAt    DateTime? // Kiedy faktycznie rozpoczƒôto wysy≈Çkƒô
  sendingCompletedAt  DateTime? // Kiedy zako≈Ñczono wysy≈Çkƒô
  delayBetweenEmails  Int       @default(90) // Op√≥≈∫nienie miƒôdzy mailami w sekundach (90s = 1.5min)
  maxEmailsPerHour    Int       @default(40) // Max maili na godzinƒô
  
  // Ustawienia okien czasowych
  allowedDays         String    @default("MON,TUE,WED,THU,FRI") // Dni tygodnia
  startHour           Int       @default(9)   // PoczƒÖtek okna (9:00)
  endHour             Int       @default(15)  // Koniec okna (15:00)
  respectHolidays     Boolean   @default(true) // Uwzglƒôdniaj ≈õwiƒôta
  targetCountries     String?   // Kraje do sprawdzania ≈õwiƒÖt (np. "PL,DE,FR")
  
  // Follow-upy
  isFollowUp          Boolean   @default(false) // Czy to kampania follow-up
  parentCampaignId    Int?      // ID kampanii nadrzƒôdnej
  followUpSequence    Int?      // Numer follow-upu (1 = pierwszy follow-up, 2 = drugi, etc.)
  followUpDays        Int       @default(7)    // Po ilu dniach wys≈Çaƒá follow-up (liczƒÖc od zako≈Ñczenia poprzedniej kampanii)
  parentCampaign      Campaign? @relation("FollowUps", fields: [parentCampaignId], references: [id])
  followUpCampaigns   Campaign[] @relation("FollowUps")
  
  // Kolejkowanie
  queuePriority       Int       @default(999) // Im ni≈ºsza liczba, tym wy≈ºszy priorytet (1 = najwy≈ºszy)
  estimatedStartDate  DateTime? // Szacowana data rozpoczƒôcia (kalkulowana)
  estimatedEndDate    DateTime? // Szacowana data zako≈Ñczenia (kalkulowana)
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  leads       Lead[]
  sendLogs    SendLog[]
  CampaignLead CampaignLead[]
  replies     InboxReply[]
}

model Lead {
  id             Int       @id @default(autoincrement())
  firstName      String?
  lastName       String?
  title          String?
  company        String?
  email          String    @unique
  industry       String?
  keywords       String?
  linkedinUrl    String?
  websiteUrl     String?
  companyCity    String?
  companyCountry String?
  language       String?   @default("pl") // pl, en, de, fr
  personalization String?  // AI-generated or manually edited personalization
  greetingForm   String?   // "Dzie≈Ñ dobry Panie Krystianie" - odmiana imienia
  
  // NEW STATUS SYSTEM
  status         String    @default("AKTYWNY") // AKTYWNY, ZAINTERESOWANY, BLOKADA, CZEKAJ, TEST
  subStatus      String?   // ZAINTERESOWANY_CAMPAIGN, BLOKADA_REFUSAL, CZEKAJ_MAYBE, etc.
  blockedCampaigns String? // JSON array of campaign IDs [1,2,3]
  reactivatedAt  DateTime? // When was reactivated
  lastReactivation String? // From which status was reactivated
  
  // LEAD RELATIONSHIPS AND SOURCES
  originalLeadId Int?      // ID of lead that "created" this lead (OOO, REDIRECT)
  originalLead   Lead?     @relation("LeadDerivatives", fields: [originalLeadId], references: [id])
  derivativeLeads Lead[]   @relation("LeadDerivatives")
  source         String?   // CSV_IMPORT, OOO_RESPONSE, REDIRECT_RESPONSE, UNATTACHED
  sourceDetails  String?   // JSON with additional information
  
  // DEPRECATED FIELDS (keep for backward compatibility)
  blockedReason  String?   // SPAM, UNSUBSCRIBE, BOUNCE, INVALID_EMAIL, MANUAL
  blockedAt      DateTime?
  isBlocked      Boolean   @default(false) // Deprecated - u≈ºyj status
  campaignId     Int?
  campaign       Campaign? @relation(fields: [campaignId], references: [id])
  
  // RELATIONS
  SendLog        SendLog[]
  CampaignLead   CampaignLead[]
  LeadTag        LeadTag[]
  replies        InboxReply[]
  statusHistory  LeadStatusHistory[]
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @default(now()) @updatedAt
}

model SendLog {
  id         Int      @id @default(autoincrement())
  campaignId Int?     // Opcjonalne - maile testowe/warmup nie majƒÖ kampanii
  leadId     Int?     // Opcjonalne - maile testowe/warmup nie majƒÖ leada
  mailboxId  Int?     // NOWE: Z kt√≥rej skrzynki wys≈Çano
  messageId  String?
  threadId   String?
  subject    String?  // NOWE: Temat wys≈Çanego maila
  content    String?  // NOWE: Tre≈õƒá wys≈Çanego maila
  status     String   @default("queued")
  error      String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  campaign   Campaign? @relation(fields: [campaignId], references: [id])
  lead       Lead?     @relation(fields: [leadId], references: [id])
  mailbox    Mailbox?  @relation(fields: [mailboxId], references: [id])
}

model InboxReply {
  id              Int      @id @default(autoincrement())
  leadId          Int?
  campaignId      Int?
  messageId       String   @unique
  threadId        String?
  subject         String
  content         String   // Pe≈Çna tre≈õƒá odpowiedzi
  originalMessage String?  // Oryginalny mail (wys≈Çany przez nas)
  fromEmail       String
  toEmail         String?  // NOWE: Na kt√≥rƒÖ skrzynkƒô przyszed≈Ç mail
  receivedAt      DateTime
  
  // AI klasyfikacja
  classification  String?  // INTERESTED | UNSUBSCRIBE | OOO | REDIRECT | BOUNCE | OTHER
  sentiment       String?  // positive | negative | neutral
  aiSummary       String?  // Kr√≥tkie podsumowanie AI
  suggestedAction String?  // Co zrobiƒá dalej
  extractedEmails String?  // JSON array nowych emaili (zastƒôpcy)
  extractedData   String?  // JSON z dodatkowymi danymi (imiona, OOO dates, etc)
  
  // Akcje wykonane przez system
  wasForwarded    Boolean  @default(false)
  forwardedAt     DateTime?
  wasBlocked      Boolean  @default(false)
  newContactsAdded Int     @default(0)
  
  // Status obs≈Çugi przez u≈ºytkownika
  isRead          Boolean  @default(false)
  isHandled       Boolean  @default(false)
  handledAt       DateTime?
  handledNote     String?  // Notatka u≈ºytkownika
  
  createdAt       DateTime @default(now())
  
  lead     Lead?     @relation(fields: [leadId], references: [id])
  campaign Campaign? @relation(fields: [campaignId], references: [id])
}

model CampaignLead {
  id         Int       @id @default(autoincrement())
  campaignId Int
  leadId     Int
  status     String   @default("planned") // planned | queued | sent | failed | replied
  priority   Int      @default(999) // Im ni≈ºsza liczba, tym wy≈ºszy priorytet (1 = najwy≈ºszy, 999 = normalny)
  sentAt     DateTime?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  campaign   Campaign @relation(fields: [campaignId], references: [id])
  lead       Lead     @relation(fields: [leadId], references: [id])

  @@unique([campaignId, leadId])
}

model Tag {
  id        Int      @id @default(autoincrement())
  name      String   @unique
  color     String   @default("#3B82F6") // hex color
  description String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  LeadTag   LeadTag[]
}

model LeadTag {
  id     Int @id @default(autoincrement())
  leadId Int
  tagId  Int
  createdAt DateTime @default(now())

  lead Lead @relation(fields: [leadId], references: [id])
  tag  Tag  @relation(fields: [tagId], references: [id])

  @@unique([leadId, tagId])
}

model CompanySettings {
  id            Int       @id @default(autoincrement())
  companyName   String    @default("Kreativia")
  address       String?   // Adres firmy (np. "**Showroom & Office & Production:**\nul. Bukowska 16\n62-081 Wysogotowo, PL")
  logoBase64    String?   // Logo jako base64
  disclaimerPl  String?   // "W razie braku zainteresowania..." - Polski
  disclaimerEn  String?   // "In case of no interest..." - English
  disclaimerDe  String?   // "Bei fehlendem Interesse..." - Deutsch
  disclaimerFr  String?   // "En cas d'absence d'int√©r√™t..." - Fran√ßais
  legalFooter   String?   // Stopka prawna
  forwardEmail  String?   // Email do powiadomie≈Ñ (forwarding zainteresowanych)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model Holiday {
  id          Int      @id @default(autoincrement())
  date        DateTime // Data ≈õwiƒôta
  name        String   // Nazwa ≈õwiƒôta
  countryCode String   // Kod kraju (PL, DE, FR, etc.)
  year        Int      // Rok
  createdAt   DateTime @default(now())
  
  @@unique([date, countryCode])
  @@index([countryCode, year])
}

model AIRules {
  id            String   @id @default(cuid())
  classification String   // INTERESTED, NOT_INTERESTED, etc.
  pattern        String?  // Regex pattern
  keywords       String   // JSON array of keywords
  confidence     Float    // 0.0 - 1.0
  priority       Int      @default(0) // Wy≈ºszy = wa≈ºniejszy
  createdBy      String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  isActive       Boolean  @default(true)
  description    String?
  
  @@index([classification])
  @@index([isActive])
  @@index([priority])
}

model AIChatHistory {
  id           String   @id @default(cuid())
  userMessage  String
  aiResponse   String
  rulesCreated String?  // JSON array of rule IDs
  createdAt    DateTime @default(now())
  userId       String?
  
  @@index([createdAt])
}

model Mailbox {
  id                   Int      @id @default(autoincrement())
  virtualSalespersonId Int
  
  // Dane skrzynki
  email                String   @unique
  displayName          String?  // Opcjonalna nazwa wy≈õwietlana (je≈õli r√≥≈ºna od handlowca)
  description          String?  // Opis skrzynki (np. "Skrzynka g≈Ç√≥wna", "Backup")
  
  // SMTP settings
  smtpHost             String
  smtpPort             Int
  smtpUser             String
  smtpPass             String   // Zahaszowane has≈Ço
  smtpSecure           Boolean  @default(false) // true = SSL (465), false = TLS (587)
  
  // IMAP settings
  imapHost             String
  imapPort             Int
  imapUser             String
  imapPass             String   // Zahaszowane has≈Ço
  imapSecure           Boolean  @default(true)  // true = SSL (993), false = TLS (143)
  
  // Limity i status
  dailyEmailLimit      Int      @default(50)    // Max maili dziennie z tej skrzynki
  currentDailySent     Int      @default(0)     // Ile wys≈Çano dzisiaj
  lastResetDate        DateTime?                // Kiedy ostatnio zresetowano licznik
  isActive             Boolean  @default(true)  // Czy skrzynka jest aktywna
  
  // Typ skrzynki
  mailboxType          String   @default("new") // new | warmed_up - czy skrzynka wymaga warmup
  
  // Weryfikacja skrzynki
  verificationStatus   String   @default("pending") // pending | verifying | verified | failed
  verificationError    String?                      // B≈ÇƒÖd weryfikacji (je≈õli failed)
  verificationDate     DateTime?                    // Kiedy zweryfikowano
  lastVerificationTest DateTime?                    // Ostatni test po≈ÇƒÖczenia
  
  // Priorytet (dla round-robin)
  priority             Int      @default(999)   // Im ni≈ºsza liczba, tym wy≈ºszy priorytet
  
  // Statystyki
  totalEmailsSent      Int      @default(0)     // ≈ÅƒÖczna liczba wys≈Çanych maili
  lastUsedAt           DateTime?                // Kiedy ostatnio u≈ºyto tej skrzynki
  
  // ============================================================================
  // WARMUP SYSTEM - Rozgrzewanie nowych skrzynek mailowych
  // ============================================================================
  
  // Status warmup
  warmupStatus         String   @default("inactive") // inactive | dns_pending | ready_to_warmup | warming | ready | failed
  warmupStartDate      DateTime?                     // Kiedy rozpoczƒôto warmup
  warmupDay            Int      @default(0)          // Aktualny dzie≈Ñ warmup (1-21)
  warmupCompletedAt    DateTime?                     // Kiedy zako≈Ñczono warmup
  
  // Limity warmup (stopniowo rosnƒÖce)
  warmupDailyLimit     Int      @default(5)          // Aktualny limit warmup (5-100)
  warmupTodaySent      Int      @default(0)          // Ile wys≈Çano dzisiaj w warmup
  
  // DNS Setup Status
  dnsSetupCompleted    Boolean  @default(false)     // Czy skonfigurowano DNS
  mxRecordStatus       String?  // pending | configured | failed
  spfRecordStatus      String?  // pending | configured | failed
  dkimRecordStatus     String?  // pending | configured | failed  
  dmarcRecordStatus    String?  // pending | configured | failed
  dnsLastCheckedAt     DateTime?                     // Kiedy ostatnio sprawdzono DNS
  
  // Deliverability metrics
  deliverabilityScore  Int      @default(0)          // 0-100 punkt√≥w reputacji
  bounceRate           Float    @default(0.0)        // Procent bounce (0-100)
  openRate             Float    @default(0.0)        // Procent otwarƒá (0-100)
  replyRate            Float    @default(0.0)        // Procent odpowiedzi (0-100)
  spamScore            Float    @default(0.0)        // Spam score (0-10)
  
  // Warmup configuration
  warmupPhase          String   @default("silent")   // silent | building | acceleration | ready
  warmupInternalEmails Int      @default(0)          // Liczba wys≈Çanych maili wewnƒôtrznych (miƒôdzy naszymi skrzynkami)
  warmupTestEmails     Int      @default(0)          // Liczba wys≈Çanych maili testowych
  
  // Warmup alerts and issues
  warmupIssues         String?  // JSON array z problemami ["high_bounce_rate", "dns_missing"]
  lastWarmupAlert      DateTime?                     // Ostatnie ostrze≈ºenie
  
  // NOWE: Timing warmup (dla nowego systemu kolejki)
  lastWarmupEmailAt    DateTime?                     // Ostatni wys≈Çany mail warmup
  nextWarmupEmailAt    DateTime?                     // Nastƒôpny zaplanowany mail
  
  // Relacje
  virtualSalesperson   VirtualSalesperson @relation(fields: [virtualSalespersonId], references: [id], onDelete: Cascade)
  mainMailboxFor       VirtualSalesperson[] @relation("MainMailbox") // Skrzynki kt√≥re sƒÖ g≈Ç√≥wne dla handlowc√≥w
  sendLogs             SendLog[]
  warmupEmails         WarmupEmail[]
  warmupQueue          WarmupQueue[]
  
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  
  @@index([virtualSalespersonId])
  @@index([isActive, currentDailySent])
  @@index([warmupStatus])
  @@index([dnsSetupCompleted])
}

// ============================================================================
// AI CONTENT PLANNER - Modu≈Ç planowania tre≈õci kampanii
// ============================================================================

model ProductGroup {
  id              Int             @id @default(autoincrement())
  name            String          // "Podwieszenia Targowe"
  description     String?
  targetAudience  String?         // "Wykonawcy stoisk, agencje eventowe"
  markets         String?         // "PL,DE,FR" - docelowe rynki
  iconEmoji       String?         @default("üì¶") // Ikona grupy
  isActive        Boolean         @default(true)
  
  // NOWE: Chat AI na poziomie grupy (pamiƒôta wszystko o produkcie!)
  conversationHistory String?     // JSON array - ca≈Ça rozmowa o tym produkcie
  lastAIResponse      String?     // Cache ostatniej odpowiedzi
  
  campaignThemes  CampaignTheme[] // DEPRECATED - do usuniƒôcia
  savedContents   SavedContent[]  // NOWE: Zapisane tre≈õci z rozmowy
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
}

model CampaignTheme {
  id                  Int               @id @default(autoincrement())
  productGroupId      Int
  name                String            // "Szybki monta≈º - 15 minut"
  description         String?
  
  // AI Conversation & Briefing
  conversationHistory String?           // JSON array of messages
  briefingData        String?           // JSON object with collected briefing
  lastAIResponse      String?           // Ostatnia odpowied≈∫ AI (cache)
  
  // Briefing fields (extracted for easy access)
  targetAudience      String?
  problemStatement    String?
  mainArguments       String?
  callToAction        String?
  language            String?           @default("pl")
  toneOfVoice         String?
  emailLength         String?           // "short" | "medium" | "long"
  
  // Status
  status              String            @default("draft") // draft | in_briefing | ready | approved | archived
  briefingProgress    Int               @default(0) // 0-100%
  
  // Relations
  productGroup        ProductGroup      @relation(fields: [productGroupId], references: [id], onDelete: Cascade)
  versions            CampaignVersion[]
  
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  
  @@index([productGroupId])
  @@index([status])
}

model CampaignVersion {
  id                Int            @id @default(autoincrement())
  campaignThemeId   Int
  versionNumber     Int            // 1, 2, 3, 4...
  type              String         // "initial" | "followup_1" | "followup_2" | "followup_3" | "followup_4"
  variantLetter     String?        // "A" | "B" | "C" - dla 3 wariant√≥w tego samego typu
  
  // Content
  subject           String
  content           String
  
  // AI Metadata
  aiRationale       String?        // Dlaczego AI to zaproponowa≈Ç
  aiModel           String?        // "gpt-4o" - jaki model u≈ºyto
  generatedAt       DateTime       @default(now())
  
  // User Feedback
  userFeedback      String?        // Twoje uwagi/komentarze
  userRating        Int?           // 1-5 gwiazdek
  
  // Status
  status            String         @default("draft") // draft | approved | rejected | in_use
  approvedAt        DateTime?
  approvedBy        String?        // User email/name
  
  // Metadata (JSON)
  metadata          String?        // {cta, tone, length, arguments: [...]}
  
  // Relations
  campaignTheme     CampaignTheme  @relation(fields: [campaignThemeId], references: [id], onDelete: Cascade)
  campaigns         Campaign[]     // Kampanie utworzone z tej wersji
  
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  
  @@unique([campaignThemeId, versionNumber, type, variantLetter])
  @@index([campaignThemeId, status])
  @@index([status])
}

// ============================================================================
// SAVED CONTENT - Zapisane tre≈õci z rozmowy z AI
// ============================================================================

model SavedContent {
  id              Int      @id @default(autoincrement())
  productGroupId  Int
  
  // Podstawowe dane
  name            String   // "Szybki monta≈º v1", "Certyfikaty PL", "Follow-up monta≈º"
  subject         String   // Temat maila
  content         String   // Tre≈õƒá maila
  
  // Typ i kategoria
  type            String   // "initial" | "followup_1" | "followup_2" | "followup_3" | "followup_4"
  language        String   @default("pl") // "pl" | "en" | "de"
  
  // Metadata
  notes           String?  // Twoje notatki/uwagi
  tags            String?  // "szybki-monta≈º,certyfikaty" - do filtrowania
  sourceType      String   @default("manual") // "ai" | "manual" | "imported"
  
  // Statystyki u≈ºycia
  usageCount      Int      @default(0) // Ile razy u≈ºyto w kampaniach
  lastUsedAt      DateTime?
  
  // Status
  isActive        Boolean  @default(true)
  isFavorite      Boolean  @default(false) // Oznacz jako ulubiony
  
  // Relacje
  productGroup    ProductGroup @relation(fields: [productGroupId], references: [id], onDelete: Cascade)
  campaigns       Campaign[]   // Kampanie kt√≥re u≈ºywajƒÖ tej tre≈õci
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([productGroupId])
  @@index([type, language])
  @@index([isActive, isFavorite])
}

// ============================================================================
// AI META-AGENT - Konfiguracja zachowania AI Content Assistant
// ============================================================================

model AIPersonaConfig {
  id                Int      @id @default(autoincrement())
  
  // Historia rozmowy z meta-agentem
  configHistory     String?  // JSON array [{role, content, timestamp}]
  lastUserMessage   String?  // Ostatnia wiadomo≈õƒá usera (cache)
  lastAIResponse    String?  // Ostatnia odpowied≈∫ AI (cache)
  
  // Ekstraktowane zasady (parsowane przez meta-AI)
  globalRules       String?  // JSON object {maxLength, tone, structure, ...}
  groupSpecificRules String? // JSON object {groupId: {rules}}
  
  // Wygenerowany SYSTEM_PERSONA (auto-generated przez meta-AI)
  generatedPrompt   String?  // Pe≈Çny system prompt u≈ºywany przez Content AI
  promptVersion     Int      @default(1) // Wersja promptu (inkrementowana przy zmianach)
  
  // Metadata
  isActive          Boolean  @default(true)
  createdBy         String?  @default("system")
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

// Token usage tracking
model AITokenUsage {
  id          Int      @id @default(autoincrement())
  
  // Kontekst wywo≈Çania
  operation   String   // np. "email_classification", "content_generation", "name_inflection"
  model       String   // np. "gpt-4o", "gpt-4o-mini"
  
  // Tokeny
  promptTokens      Int   // Tokeny wej≈õciowe
  completionTokens  Int   // Tokeny wyj≈õciowe
  totalTokens       Int   // Suma
  
  // Estymowany koszt (w USD)
  estimatedCost     Float @default(0.0)
  
  // Dodatkowe info
  metadata    String?  // JSON z dodatkowymi danymi (np. leadId, campaignId)
  
  createdAt   DateTime @default(now())
}

// ============================================================================
// WARMUP EMAILS - Maile wysy≈Çane w ramach rozgrzewania skrzynek
// ============================================================================

model WarmupEmail {
  id              Int      @id @default(autoincrement())
  mailboxId       Int
  
  // Typ warmup maila
  type            String   // internal | seed | test | campaign
  subtype         String?  // test_connection | internal_notification | seed_friendly | campaign_sample
  
  // Dane maila
  toEmail         String   // Adres odbiorcy
  subject         String   // Temat maila
  content         String   // Tre≈õƒá maila
  messageId       String?  // ID wiadomo≈õci (z SMTP)
  
  // Status wysy≈Çki
  status          String   @default("queued") // queued | sent | failed | bounced
  sentAt          DateTime?                   // Kiedy wys≈Çano
  errorMessage    String?                     // B≈ÇƒÖd je≈õli failed
  
  // Tracking (tylko dla seed/campaign)
  wasOpened       Boolean  @default(false)    // Czy otwarto mail
  wasReplied      Boolean  @default(false)    // Czy odpowiedziano
  openedAt        DateTime?                   // Kiedy otwarto
  repliedAt       DateTime?                   // Kiedy odpowiedziano
  
  // Warmup day info
  warmupDay       Int                         // Dzie≈Ñ warmup (1-21)
  warmupPhase     String                      // silent | building | acceleration
  
  // Metadata
  metadata        String?                     // JSON z dodatkowymi danymi
  
  // Relacje
  mailbox         Mailbox @relation(fields: [mailboxId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([mailboxId])
  @@index([type])
  @@index([status])
  @@index([warmupDay])
}

// ============================================================================
// WARMUP QUEUE - Kolejka maili warmup (nowy system z timing)
// ============================================================================

model WarmupQueue {
  id              Int      @id @default(autoincrement())
  mailboxId       Int
  
  // Planowanie
  scheduledAt     DateTime // Dok≈Çadny czas wysy≈Çki (np. 2025-10-19 07:23:00)
  
  // Typ maila
  emailType       String   // internal | seed
  
  // Dane maila
  toEmail         String   // Adres odbiorcy
  subject         String   // Temat maila
  body            String   // Tre≈õƒá maila
  
  // Status wysy≈Çki
  status          String   @default("pending") // pending | sending | sent | failed | cancelled
  sentAt          DateTime?                    // Kiedy wys≈Çano
  error           String?                      // B≈ÇƒÖd je≈õli failed
  
  // Metadata
  warmupDay       Int                          // Dzie≈Ñ warmup (1-30)
  metadata        String?                      // JSON z dodatkowymi danymi
  
  // Relacje
  mailbox         Mailbox @relation(fields: [mailboxId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([mailboxId])
  @@index([scheduledAt, status])
  @@index([status])
}

model LeadStatusHistory {
  id          Int      @id @default(autoincrement())
  leadId      Int
  lead        Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  
  // Status change details
  oldStatus   String?  // Previous status
  oldSubStatus String? // Previous sub-status
  newStatus   String   // New status
  newSubStatus String? // New sub-status
  
  // Change reason and metadata
  reason      String?  // Reason for change (e.g., "MANUAL", "AI_CLASSIFICATION", "REACTIVATION")
  changedBy   String?  // Who made the change (e.g., "USER", "AI", "SYSTEM")
  notes       String?  // Additional notes
  
  // Timestamps
  createdAt   DateTime @default(now())
  
  @@index([leadId])
  @@index([createdAt])
  @@index([newStatus])
}

