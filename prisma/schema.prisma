datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model VirtualSalesperson {
  id       Int     @id @default(autoincrement())
  name     String // np. "Marta Å»Ã³Å‚kowska"
  email    String  @unique // Email gÅ‚Ã³wny (dla referencji)
  phone    String? // nr telefonu
  language String  @default("pl") // pl, en, de, fr
  markets  String? // np. "Polska, Niemcy" - rynki na ktÃ³re moÅ¼e wysyÅ‚aÄ‡

  // GÅ‚Ã³wna skrzynka mailowa (uÅ¼ywana jako pierwsza w round-robin)
  mainMailboxId Int? // ID skrzynki gÅ‚Ã³wnej
  mainMailbox   Mailbox? @relation("MainMailbox", fields: [mainMailboxId], references: [id])

  // SMTP settings - DEPRECATED (uÅ¼ywaj Mailbox)
  smtpHost   String? // np. "bartgrafic.home.pl"
  smtpPort   Int? // np. 587
  smtpUser   String? // login SMTP
  smtpPass   String? // hasÅ‚o SMTP
  smtpSecure Boolean @default(false) // true = SSL (465), false = TLS (587)

  // IMAP settings - DEPRECATED (uÅ¼ywaj Mailbox)
  imapHost   String? // np. "bartgrafic.home.pl"
  imapPort   Int? // np. 993 lub 143
  imapUser   String? // login IMAP (czÄ™sto ten sam co SMTP)
  imapPass   String? // hasÅ‚o IMAP (czÄ™sto to samo co SMTP)
  imapSecure Boolean @default(true) // true = SSL (993), false = TLS (143)

  // Limity wysyÅ‚ki - DEPRECATED (uÅ¼ywaj Mailbox)
  dailyEmailLimit  Int       @default(150) // Max maili dziennie dla tego handlowca
  currentDailySent Int       @default(0) // Ile wysÅ‚ano dzisiaj
  lastResetDate    DateTime? // Kiedy ostatnio zresetowano licznik

  // Prawdziwy handlowiec (dla forwardowania zainteresowanych leadÃ³w)
  realSalespersonEmail     String? // Email prawdziwego handlowca
  realSalespersonName      String? // ImiÄ™ i nazwisko prawdziwego handlowca
  realSalespersonPhone     String? // Telefon prawdziwego handlowca
  realSalespersonSignature String? // Podpis/tytuÅ‚ prawdziwego handlowca (np. "New Business Development")

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  campaigns Campaign[]
  mailboxes Mailbox[] // NOWE: Wiele skrzynek mailowych dla tego handlowca
}

model Campaign {
  id                   Int                 @id @default(autoincrement())
  name                 String
  description          String?
  subject              String? // Temat maila
  text                 String? // Tekst kampanii z ChatGPT
  jobDescription       String? // Opis stanowiska pod imieniem handlowca
  postscript           String? // PS. na koÅ„cu
  linkText             String? // Tekst wyÅ›wietlany linku (np. "Visit our site: www.kreativia.eu")
  linkUrl              String? // URL docelowy (opcjonalny, jeÅ›li pusty uÅ¼ywa linkText jako URL)
  gmailLabel           String?
  dailyLimit           Int                 @default(200)
  virtualSalespersonId Int?
  virtualSalesperson   VirtualSalesperson? @relation(fields: [virtualSalespersonId], references: [id])

  // AI Content Planner
  contentVersionId Int? // DEPRECATED - stara wersja
  contentVersion   CampaignVersion? @relation(fields: [contentVersionId], references: [id])
  savedContentId   Int? // NOWE: Z ktÃ³rego SavedContent pochodzi treÅ›Ä‡
  savedContent     SavedContent?    @relation(fields: [savedContentId], references: [id])

  // Harmonogram wysyÅ‚ki
  status             String    @default("DRAFT") // DRAFT, SCHEDULED, IN_PROGRESS, COMPLETED, PAUSED, CANCELLED
  scheduledAt        DateTime? // Kiedy wysÅ‚aÄ‡ kampaniÄ™
  sendingStartedAt   DateTime? // Kiedy faktycznie rozpoczÄ™to wysyÅ‚kÄ™
  sendingCompletedAt DateTime? // Kiedy zakoÅ„czono wysyÅ‚kÄ™
  delayBetweenEmails Int       @default(90) // OpÃ³Åºnienie miÄ™dzy mailami w sekundach (90s = 1.5min)
  maxEmailsPerDay    Int       @default(500) // Max maili dziennie dla kampanii

  // Ustawienia okien czasowych
  allowedDays     String  @default("MON,TUE,WED,THU,FRI") // Dni tygodnia
  startHour       Int     @default(9) // PoczÄ…tek okna (9:00)
  startMinute     Int     @default(0) // Minuty poczÄ…tku okna (0-59)
  endHour         Int     @default(15) // Koniec okna (15:00)
  endMinute       Int     @default(0) // Minuty koÅ„ca okna (0-59)
  respectHolidays Boolean @default(true) // UwzglÄ™dniaj Å›wiÄ™ta
  targetCountries String? // Kraje do sprawdzania Å›wiÄ…t (np. "PL,DE,FR")

  // Follow-upy
  isFollowUp        Boolean    @default(false) // Czy to kampania follow-up
  parentCampaignId  Int? // ID kampanii nadrzÄ™dnej
  followUpSequence  Int? // Numer follow-upu (1 = pierwszy follow-up, 2 = drugi, etc.)
  followUpDays      Int        @default(7) // Po ilu dniach wysÅ‚aÄ‡ follow-up (liczÄ…c od zakoÅ„czenia poprzedniej kampanii)
  parentCampaign    Campaign?  @relation("FollowUps", fields: [parentCampaignId], references: [id])
  followUpCampaigns Campaign[] @relation("FollowUps")

  // Kolejkowanie
  queuePriority      Int       @default(999) // Im niÅ¼sza liczba, tym wyÅ¼szy priorytet (1 = najwyÅ¼szy)
  estimatedStartDate DateTime? // Szacowana data rozpoczÄ™cia (kalkulowana)
  estimatedEndDate   DateTime? // Szacowana data zakoÅ„czenia (kalkulowana)

  // A/B Testing
  abTestEnabled Boolean @default(false) // Czy A/B test jest wÅ‚Ä…czony
  abTestMode    String? // "alternating" | "random" | "hash" - metoda rozdziaÅ‚u wariantÃ³w

  // Wariant B (wariant A uÅ¼ywa istniejÄ…cych pÃ³l: subject, text, jobDescription, postscript, linkText, linkUrl)
  subjectB        String? // Temat maila - wariant B
  textB           String? // Tekst kampanii - wariant B
  jobDescriptionB String? // Opis stanowiska - wariant B
  postscriptB     String? // PS. na koÅ„cu - wariant B
  linkTextB       String? // Tekst linku - wariant B
  linkUrlB        String? // URL linku - wariant B

  // Automatyczne odpowiedzi z materiaÅ‚ami
  autoReplyEnabled           Boolean @default(false)
  autoReplyContext           String? // Kontekst dla AI (np. "JesteÅ›my drukarniÄ…")
  autoReplyRules             String? // JSON z reguÅ‚ami (co uwaÅ¼aÄ‡ za proÅ›bÄ™ o materiaÅ‚y)
  autoReplyDelayMinutes      Int     @default(15) // OpÃ³Åºnienie przed wysÅ‚aniem odpowiedzi
  autoReplyContent           String? // Statyczna treÅ›Ä‡ odpowiedzi (moÅ¼e zawieraÄ‡ {firstName}, {materials})
  autoReplyGuardianTemplate  String? // Szablon informacji o opiekunie klienta (moÅ¼e zawieraÄ‡ {name}, {email}, {phone}, {title})
  autoReplyGuardianTitle     String? // TytuÅ‚ opiekuna klienta (np. "New Business Development")
  autoReplyIncludeGuardian   Boolean @default(false) // Czy dodaÄ‡ informacjÄ™ o opiekunie do odpowiedzi
  autoReplyGuardianIntroText String? // WstÄ™pny tekst przed danymi opiekuna (np. "TwÃ³j opiekun klienta:")

  createdAt                DateTime                     @default(now())
  updatedAt                DateTime                     @updatedAt
  leads                    Lead[]
  sendLogs                 SendLog[]
  CampaignLead             CampaignLead[]
  CampaignEmailQueue       CampaignEmailQueue[]
  replies                  InboxReply[]
  notifications            InterestedLeadNotification[]
  materials                Material[]
  materialResponses        MaterialResponse[]
  pendingMaterialDecisions PendingMaterialDecision[]
}

model Lead {
  id              Int     @id @default(autoincrement())
  firstName       String?
  lastName        String?
  title           String?
  company         String?
  email           String  @unique
  industry        String?
  keywords        String?
  linkedinUrl     String?
  websiteUrl      String?
  companyCity     String?
  companyCountry  String?
  language        String? @default("pl") // pl, en, de, fr
  personalization String? // AI-generated or manually edited personalization
  greetingForm    String? // "DzieÅ„ dobry Panie Krystianie" - odmiana imienia

  // NEW STATUS SYSTEM
  status           String    @default("AKTYWNY") // AKTYWNY, ZAINTERESOWANY, BLOKADA, CZEKAJ, TEST
  subStatus        String? // ZAINTERESOWANY_CAMPAIGN, BLOKADA_REFUSAL, CZEKAJ_MAYBE, etc.
  blockedCampaigns String? // JSON array of campaign IDs [1,2,3]
  reactivatedAt    DateTime? // When was reactivated
  lastReactivation String? // From which status was reactivated

  // CRM MODULE
  inCRM            Boolean   @default(false) // Czy lead jest w module CRM
  crmEnteredAt     DateTime? // Kiedy lead trafiÅ‚ do CRM
  crmReadyForSales Boolean   @default(false) // Czy gotowy do przekazania do handlowca

  // LEAD RELATIONSHIPS AND SOURCES
  originalLeadId  Int? // ID of lead that "created" this lead (OOO, REDIRECT)
  originalLead    Lead?   @relation("LeadDerivatives", fields: [originalLeadId], references: [id])
  derivativeLeads Lead[]  @relation("LeadDerivatives")
  source          String? // CSV_IMPORT, OOO_RESPONSE, REDIRECT_RESPONSE, UNATTACHED
  sourceDetails   String? // JSON with additional information

  // DEPRECATED FIELDS (keep for backward compatibility)
  blockedReason String? // SPAM, UNSUBSCRIBE, BOUNCE, INVALID_EMAIL, MANUAL
  blockedAt     DateTime?
  isBlocked     Boolean   @default(false) // Deprecated - uÅ¼yj status
  campaignId    Int?
  campaign      Campaign? @relation(fields: [campaignId], references: [id])

  // RELATIONS
  SendLog                  SendLog[]
  CampaignLead             CampaignLead[]
  LeadTag                  LeadTag[]
  replies                  InboxReply[]
  statusHistory            LeadStatusHistory[]
  notifications            InterestedLeadNotification[]
  materialResponses        MaterialResponse[]
  pendingMaterialDecisions PendingMaterialDecision[]
  createdAt                DateTime                     @default(now())
  updatedAt                DateTime                     @default(now()) @updatedAt
}

model SendLog {
  id            Int       @id @default(autoincrement())
  campaignId    Int? // Opcjonalne - maile testowe/warmup nie majÄ… kampanii
  leadId        Int? // Opcjonalne - maile testowe/warmup nie majÄ… leada
  mailboxId     Int? // NOWE: Z ktÃ³rej skrzynki wysÅ‚ano
  toEmail       String? // NOWE: Do kogo wysÅ‚ano mail (dla powiadomieÅ„)
  messageId     String?
  threadId      String?
  subject       String? // NOWE: Temat wysÅ‚anego maila
  content       String? // NOWE: TreÅ›Ä‡ wysÅ‚anego maila
  variantLetter String? // "A" | "B" - ktÃ³ry wariant A/B zostaÅ‚ uÅ¼yty (null = wariant A lub brak testu)
  status        String    @default("queued")
  error         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  campaign      Campaign? @relation(fields: [campaignId], references: [id])
  lead          Lead?     @relation(fields: [leadId], references: [id])
  mailbox       Mailbox?  @relation(fields: [mailboxId], references: [id])

  // Zapobiega wysÅ‚aniu tego samego maila wiele razy do tego samego leada (race condition)
  @@index([campaignId, leadId, status])
}

model InboxReply {
  id              Int      @id @default(autoincrement())
  leadId          Int?
  campaignId      Int?
  mailboxId       Int? // NOWE: Z ktÃ³rej skrzynki mailowej przyszedÅ‚ mail
  messageId       String   @unique
  threadId        String?
  subject         String
  content         String // PeÅ‚na treÅ›Ä‡ odpowiedzi
  originalMessage String? // Oryginalny mail (wysÅ‚any przez nas)
  fromEmail       String
  toEmail         String? // NOWE: Na ktÃ³rÄ… skrzynkÄ™ przyszedÅ‚ mail
  receivedAt      DateTime

  // AI klasyfikacja
  classification  String? // INTERESTED | UNSUBSCRIBE | OOO | REDIRECT | BOUNCE | OTHER
  sentiment       String? // positive | negative | neutral
  aiSummary       String? // KrÃ³tkie podsumowanie AI
  suggestedAction String? // Co zrobiÄ‡ dalej
  extractedEmails String? // JSON array nowych emaili (zastÄ™pcy)
  extractedData   String? // JSON z dodatkowymi danymi (imiona, OOO dates, etc)

  // Akcje wykonane przez system
  wasForwarded     Boolean   @default(false)
  forwardedAt      DateTime?
  wasBlocked       Boolean   @default(false)
  newContactsAdded Int       @default(0)

  // Status obsÅ‚ugi przez uÅ¼ytkownika
  isRead      Boolean   @default(false)
  isHandled   Boolean   @default(false)
  handledAt   DateTime?
  handledNote String? // Notatka uÅ¼ytkownika

  createdAt DateTime @default(now())

  lead                     Lead?                        @relation(fields: [leadId], references: [id])
  campaign                 Campaign?                    @relation(fields: [campaignId], references: [id])
  mailbox                  Mailbox?                     @relation(fields: [mailboxId], references: [id])
  notifications            InterestedLeadNotification[]
  materialResponses        MaterialResponse[]
  pendingMaterialDecisions PendingMaterialDecision[]

  @@index([mailboxId])
}

model CampaignLead {
  id         Int       @id @default(autoincrement())
  campaignId Int
  leadId     Int
  status     String    @default("planned") // planned | queued | sent | failed | replied
  priority   Int       @default(999) // Im niÅ¼sza liczba, tym wyÅ¼szy priorytet (1 = najwyÅ¼szy, 999 = normalny)
  sentAt     DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  campaign           Campaign             @relation(fields: [campaignId], references: [id])
  lead               Lead                 @relation(fields: [leadId], references: [id])
  campaignEmailQueue CampaignEmailQueue[]

  @@unique([campaignId, leadId])
}

model Tag {
  id          Int       @id @default(autoincrement())
  name        String    @unique
  color       String    @default("#3B82F6") // hex color
  description String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  LeadTag     LeadTag[]
}

model LeadTag {
  id        Int      @id @default(autoincrement())
  leadId    Int
  tagId     Int
  createdAt DateTime @default(now())

  lead Lead @relation(fields: [leadId], references: [id])
  tag  Tag  @relation(fields: [tagId], references: [id])

  @@unique([leadId, tagId])
}

model CompanySettings {
  id           Int     @id @default(autoincrement())
  companyName  String  @default("Kreativia")
  address      String? // Adres firmy (np. "**Showroom & Office & Production:**\nul. Bukowska 16\n62-081 Wysogotowo, PL")
  logoBase64   String? // Logo jako base64
  disclaimerPl String? // "W razie braku zainteresowania..." - Polski
  disclaimerEn String? // "In case of no interest..." - English
  disclaimerDe String? // "Bei fehlendem Interesse..." - Deutsch
  disclaimerFr String? // "En cas d'absence d'intÃ©rÃªt..." - FranÃ§ais
  legalFooter  String? // Stopka prawna
  forwardEmail String? // Email do powiadomieÅ„ (forwarding zainteresowanych)

  // Ustawienia wydajnoÅ›ci skrzynek (warmup & kampanie)
  warmupPerformanceSettings String? // JSON: [{week:1, warmup:15, campaign:10}, ...]
  warmupSchedule            String? // JSON: WarmupDayConfig[] - custom harmonogram warmup (30 dni)

  // Ustawienia przypomnieÅ„ dla zainteresowanych
  reminderIntervalDays Int @default(3) // Ile dni miÄ™dzy przypomnieniami
  maxReminderCount     Int @default(2) // Ile razy przypomnieÄ‡

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Holiday {
  id          Int      @id @default(autoincrement())
  date        DateTime // Data Å›wiÄ™ta
  name        String // Nazwa Å›wiÄ™ta
  countryCode String // Kod kraju (PL, DE, FR, etc.)
  year        Int // Rok
  createdAt   DateTime @default(now())

  @@unique([date, countryCode])
  @@index([countryCode, year])
}

model AIRules {
  id             String   @id @default(cuid())
  classification String // INTERESTED, NOT_INTERESTED, etc.
  pattern        String? // Regex pattern
  keywords       String // JSON array of keywords
  confidence     Float // 0.0 - 1.0
  priority       Int      @default(0) // WyÅ¼szy = waÅ¼niejszy
  createdBy      String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  isActive       Boolean  @default(true)
  description    String?

  @@index([classification])
  @@index([isActive])
  @@index([priority])
}

model AIChatHistory {
  id           String   @id @default(cuid())
  userMessage  String
  aiResponse   String
  rulesCreated String? // JSON array of rule IDs
  createdAt    DateTime @default(now())
  userId       String?

  @@index([createdAt])
}

model Mailbox {
  id                   Int @id @default(autoincrement())
  virtualSalespersonId Int

  // Dane skrzynki
  email       String  @unique
  displayName String? // Opcjonalna nazwa wyÅ›wietlana (jeÅ›li rÃ³Å¼na od handlowca)
  description String? // Opis skrzynki (np. "Skrzynka gÅ‚Ã³wna", "Backup")

  // SMTP settings
  smtpHost   String
  smtpPort   Int
  smtpUser   String
  smtpPass   String // Zahaszowane hasÅ‚o
  smtpSecure Boolean @default(false) // true = SSL (465), false = TLS (587)

  // IMAP settings
  imapHost   String
  imapPort   Int
  imapUser   String
  imapPass   String // Zahaszowane hasÅ‚o
  imapSecure Boolean @default(true) // true = SSL (993), false = TLS (143)

  // Limity i status
  dailyEmailLimit  Int       @default(50) // Max maili dziennie z tej skrzynki
  currentDailySent Int       @default(0) // Ile wysÅ‚ano dzisiaj
  lastResetDate    DateTime? // Kiedy ostatnio zresetowano licznik
  isActive         Boolean   @default(true) // Czy skrzynka jest aktywna

  // Typ skrzynki
  mailboxType String @default("new") // new | warmed_up - czy skrzynka wymaga warmup

  // Weryfikacja skrzynki
  verificationStatus   String    @default("pending") // pending | verifying | verified | failed
  verificationError    String? // BÅ‚Ä…d weryfikacji (jeÅ›li failed)
  verificationDate     DateTime? // Kiedy zweryfikowano
  lastVerificationTest DateTime? // Ostatni test poÅ‚Ä…czenia

  // Priorytet (dla round-robin)
  priority Int @default(999) // Im niÅ¼sza liczba, tym wyÅ¼szy priorytet

  // Statystyki
  totalEmailsSent Int       @default(0) // ÅÄ…czna liczba wysÅ‚anych maili
  lastUsedAt      DateTime? // Kiedy ostatnio uÅ¼yto tej skrzynki

  // ============================================================================
  // WARMUP SYSTEM - Rozgrzewanie nowych skrzynek mailowych
  // ============================================================================

  // Status warmup
  warmupStatus      String    @default("inactive") // inactive | dns_pending | ready_to_warmup | warming | ready | failed
  warmupStartDate   DateTime? // Kiedy rozpoczÄ™to warmup
  warmupDay         Int       @default(0) // Aktualny dzieÅ„ warmup (1-21)
  warmupCompletedAt DateTime? // Kiedy zakoÅ„czono warmup

  // Limity warmup (stopniowo rosnÄ…ce)
  warmupDailyLimit Int @default(5) // Aktualny limit warmup (5-100)
  warmupTodaySent  Int @default(0) // Ile wysÅ‚ano dzisiaj w warmup

  // DNS Setup Status
  dnsSetupCompleted Boolean   @default(false) // Czy skonfigurowano DNS
  mxRecordStatus    String? // pending | configured | failed
  spfRecordStatus   String? // pending | configured | failed
  dkimRecordStatus  String? // pending | configured | failed  
  dmarcRecordStatus String? // pending | configured | failed
  dnsLastCheckedAt  DateTime? // Kiedy ostatnio sprawdzono DNS

  // Deliverability metrics
  deliverabilityScore Int   @default(0) // 0-100 punktÃ³w reputacji
  bounceRate          Float @default(0.0) // Procent bounce (0-100)
  openRate            Float @default(0.0) // Procent otwarÄ‡ (0-100)
  replyRate           Float @default(0.0) // Procent odpowiedzi (0-100)
  spamScore           Float @default(0.0) // Spam score (0-10)

  // Warmup configuration
  warmupPhase          String @default("silent") // silent | building | acceleration | ready
  warmupInternalEmails Int    @default(0) // Liczba wysÅ‚anych maili wewnÄ™trznych (miÄ™dzy naszymi skrzynkami)
  warmupTestEmails     Int    @default(0) // Liczba wysÅ‚anych maili testowych

  // Warmup alerts and issues
  warmupIssues    String? // JSON array z problemami ["high_bounce_rate", "dns_missing"]
  lastWarmupAlert DateTime? // Ostatnie ostrzeÅ¼enie

  // NOWE: Timing warmup (dla nowego systemu kolejki)
  lastWarmupEmailAt DateTime? // Ostatni wysÅ‚any mail warmup
  nextWarmupEmailAt DateTime? // NastÄ™pny zaplanowany mail

  // Relacje
  virtualSalesperson VirtualSalesperson   @relation(fields: [virtualSalespersonId], references: [id], onDelete: Cascade)
  mainMailboxFor     VirtualSalesperson[] @relation("MainMailbox") // Skrzynki ktÃ³re sÄ… gÅ‚Ã³wne dla handlowcÃ³w
  sendLogs           SendLog[]
  inboxReplies       InboxReply[] // Odpowiedzi otrzymane na tÄ™ skrzynkÄ™
  warmupEmails       WarmupEmail[]
  warmupQueue        WarmupQueue[]
  materialResponses  MaterialResponse[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([virtualSalespersonId])
  @@index([isActive, currentDailySent])
  @@index([warmupStatus])
  @@index([dnsSetupCompleted])
}

// ============================================================================
// AI CONTENT PLANNER - ModuÅ‚ planowania treÅ›ci kampanii
// ============================================================================

model ProductGroup {
  id             Int     @id @default(autoincrement())
  name           String // "Podwieszenia Targowe"
  description    String?
  targetAudience String? // "Wykonawcy stoisk, agencje eventowe"
  markets        String? // "PL,DE,FR" - docelowe rynki
  iconEmoji      String? @default("ðŸ“¦") // Ikona grupy
  isActive       Boolean @default(true)

  // NOWE: Chat AI na poziomie grupy (pamiÄ™ta wszystko o produkcie!)
  conversationHistory String? // JSON array - caÅ‚a rozmowa o tym produkcie
  lastAIResponse      String? // Cache ostatniej odpowiedzi

  campaignThemes CampaignTheme[] // DEPRECATED - do usuniÄ™cia
  savedContents  SavedContent[] // NOWE: Zapisane treÅ›ci z rozmowy

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model CampaignTheme {
  id             Int     @id @default(autoincrement())
  productGroupId Int
  name           String // "Szybki montaÅ¼ - 15 minut"
  description    String?

  // AI Conversation & Briefing
  conversationHistory String? // JSON array of messages
  briefingData        String? // JSON object with collected briefing
  lastAIResponse      String? // Ostatnia odpowiedÅº AI (cache)

  // Briefing fields (extracted for easy access)
  targetAudience   String?
  problemStatement String?
  mainArguments    String?
  callToAction     String?
  language         String? @default("pl")
  toneOfVoice      String?
  emailLength      String? // "short" | "medium" | "long"

  // Status
  status           String @default("draft") // draft | in_briefing | ready | approved | archived
  briefingProgress Int    @default(0) // 0-100%

  // Relations
  productGroup ProductGroup      @relation(fields: [productGroupId], references: [id], onDelete: Cascade)
  versions     CampaignVersion[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([productGroupId])
  @@index([status])
}

model CampaignVersion {
  id              Int     @id @default(autoincrement())
  campaignThemeId Int
  versionNumber   Int // 1, 2, 3, 4...
  type            String // "initial" | "followup_1" | "followup_2" | "followup_3" | "followup_4"
  variantLetter   String? // "A" | "B" | "C" - dla 3 wariantÃ³w tego samego typu

  // Content
  subject String
  content String

  // AI Metadata
  aiRationale String? // Dlaczego AI to zaproponowaÅ‚
  aiModel     String? // "gpt-4o" - jaki model uÅ¼yto
  generatedAt DateTime @default(now())

  // User Feedback
  userFeedback String? // Twoje uwagi/komentarze
  userRating   Int? // 1-5 gwiazdek

  // Status
  status     String    @default("draft") // draft | approved | rejected | in_use
  approvedAt DateTime?
  approvedBy String? // User email/name

  // Metadata (JSON)
  metadata String? // {cta, tone, length, arguments: [...]}

  // Relations
  campaignTheme CampaignTheme @relation(fields: [campaignThemeId], references: [id], onDelete: Cascade)
  campaigns     Campaign[] // Kampanie utworzone z tej wersji

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([campaignThemeId, versionNumber, type, variantLetter])
  @@index([campaignThemeId, status])
  @@index([status])
}

// ============================================================================
// SAVED CONTENT - Zapisane treÅ›ci z rozmowy z AI
// ============================================================================

model SavedContent {
  id             Int @id @default(autoincrement())
  productGroupId Int

  // Podstawowe dane
  name    String // "Szybki montaÅ¼ v1", "Certyfikaty PL", "Follow-up montaÅ¼"
  subject String // Temat maila
  content String // TreÅ›Ä‡ maila

  // Typ i kategoria
  type     String // "initial" | "followup_1" | "followup_2" | "followup_3" | "followup_4"
  language String @default("pl") // "pl" | "en" | "de"

  // Metadata
  notes      String? // Twoje notatki/uwagi
  tags       String? // "szybki-montaÅ¼,certyfikaty" - do filtrowania
  sourceType String  @default("manual") // "ai" | "manual" | "imported"

  // Statystyki uÅ¼ycia
  usageCount Int       @default(0) // Ile razy uÅ¼yto w kampaniach
  lastUsedAt DateTime?

  // Status
  isActive   Boolean @default(true)
  isFavorite Boolean @default(false) // Oznacz jako ulubiony

  // Relacje
  productGroup ProductGroup @relation(fields: [productGroupId], references: [id], onDelete: Cascade)
  campaigns    Campaign[] // Kampanie ktÃ³re uÅ¼ywajÄ… tej treÅ›ci

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([productGroupId])
  @@index([type, language])
  @@index([isActive, isFavorite])
}

// ============================================================================
// AI META-AGENT - Konfiguracja zachowania AI Content Assistant
// ============================================================================

model AIPersonaConfig {
  id Int @id @default(autoincrement())

  // Historia rozmowy z meta-agentem
  configHistory   String? // JSON array [{role, content, timestamp}]
  lastUserMessage String? // Ostatnia wiadomoÅ›Ä‡ usera (cache)
  lastAIResponse  String? // Ostatnia odpowiedÅº AI (cache)

  // Ekstraktowane zasady (parsowane przez meta-AI)
  globalRules        String? // JSON object {maxLength, tone, structure, ...}
  groupSpecificRules String? // JSON object {groupId: {rules}}

  // Wygenerowany SYSTEM_PERSONA (auto-generated przez meta-AI)
  generatedPrompt String? // PeÅ‚ny system prompt uÅ¼ywany przez Content AI
  promptVersion   Int     @default(1) // Wersja promptu (inkrementowana przy zmianach)

  // Metadata
  isActive  Boolean @default(true)
  createdBy String? @default("system")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Token usage tracking
model AITokenUsage {
  id Int @id @default(autoincrement())

  // Kontekst wywoÅ‚ania
  operation String // np. "email_classification", "content_generation", "name_inflection"
  model     String // np. "gpt-4o", "gpt-4o-mini"

  // Tokeny
  promptTokens     Int // Tokeny wejÅ›ciowe
  completionTokens Int // Tokeny wyjÅ›ciowe
  totalTokens      Int // Suma

  // Estymowany koszt (w USD)
  estimatedCost Float @default(0.0)

  // Dodatkowe info
  metadata String? // JSON z dodatkowymi danymi (np. leadId, campaignId)

  createdAt DateTime @default(now())
}

// ============================================================================
// WARMUP EMAILS - Maile wysyÅ‚ane w ramach rozgrzewania skrzynek
// ============================================================================

model WarmupEmail {
  id        Int @id @default(autoincrement())
  mailboxId Int

  // Typ warmup maila
  type    String // internal | seed | test | campaign
  subtype String? // test_connection | internal_notification | seed_friendly | campaign_sample

  // Dane maila
  toEmail   String // Adres odbiorcy
  subject   String // Temat maila
  content   String // TreÅ›Ä‡ maila
  messageId String? // ID wiadomoÅ›ci (z SMTP)

  // Status wysyÅ‚ki
  status       String    @default("queued") // queued | sent | failed | bounced
  sentAt       DateTime? // Kiedy wysÅ‚ano
  errorMessage String? // BÅ‚Ä…d jeÅ›li failed

  // Tracking (tylko dla seed/campaign)
  wasOpened  Boolean   @default(false) // Czy otwarto mail
  wasReplied Boolean   @default(false) // Czy odpowiedziano
  openedAt   DateTime? // Kiedy otwarto
  repliedAt  DateTime? // Kiedy odpowiedziano

  // Warmup day info
  warmupDay   Int // DzieÅ„ warmup (1-21)
  warmupPhase String // silent | building | acceleration

  // Metadata
  metadata String? // JSON z dodatkowymi danymi

  // Relacje
  mailbox Mailbox @relation(fields: [mailboxId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([mailboxId])
  @@index([type])
  @@index([status])
  @@index([warmupDay])
}

// ============================================================================
// WARMUP QUEUE - Kolejka maili warmup (nowy system z timing)
// ============================================================================

model WarmupQueue {
  id        Int @id @default(autoincrement())
  mailboxId Int

  // Planowanie
  scheduledAt DateTime // DokÅ‚adny czas wysyÅ‚ki (np. 2025-10-19 07:23:00)

  // Typ maila
  emailType String // internal | seed

  // Dane maila
  toEmail String // Adres odbiorcy
  subject String // Temat maila
  body    String // TreÅ›Ä‡ maila

  // Status wysyÅ‚ki
  status String    @default("pending") // pending | sending | sent | failed | cancelled
  sentAt DateTime? // Kiedy wysÅ‚ano
  error  String? // BÅ‚Ä…d jeÅ›li failed

  // Metadata
  warmupDay Int // DzieÅ„ warmup (1-30)
  metadata  String? // JSON z dodatkowymi danymi

  // Relacje
  mailbox Mailbox @relation(fields: [mailboxId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([mailboxId])
  @@index([scheduledAt, status])
  @@index([status])
}

// ============================================================================
// CAMPAIGN EMAIL QUEUE - Kolejka zaplanowanych maili kampanii (precyzyjne planowanie)
// ============================================================================

model CampaignEmailQueue {
  id             Int @id @default(autoincrement())
  campaignId     Int
  campaignLeadId Int // Relacja do CampaignLead (lead w kampanii)

  // Planowanie
  scheduledAt DateTime // DokÅ‚adny czas wysyÅ‚ki (np. 2025-11-04 14:31:32)

  // Status wysyÅ‚ki
  status String    @default("pending") // pending | sending | sent | failed | cancelled
  sentAt DateTime? // Kiedy wysÅ‚ano
  error  String? // BÅ‚Ä…d jeÅ›li failed

  // Metadata (opcjonalnie - dla debugowania)
  metadata String? // JSON z dodatkowymi danymi

  // Relacje
  campaign     Campaign     @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  campaignLead CampaignLead @relation(fields: [campaignLeadId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([campaignId])
  @@index([campaignLeadId])
  @@index([scheduledAt, status]) // Kluczowy indeks dla szybkiego wyszukiwania
  @@index([status])
}

model LeadStatusHistory {
  id     Int  @id @default(autoincrement())
  leadId Int
  lead   Lead @relation(fields: [leadId], references: [id], onDelete: Cascade)

  // Status change details
  oldStatus    String? // Previous status
  oldSubStatus String? // Previous sub-status
  newStatus    String // New status
  newSubStatus String? // New sub-status

  // Change reason and metadata
  reason    String? // Reason for change (e.g., "MANUAL", "AI_CLASSIFICATION", "REACTIVATION")
  changedBy String? // Who made the change (e.g., "USER", "AI", "SYSTEM")
  notes     String? // Additional notes

  // Timestamps
  createdAt DateTime @default(now())

  @@index([leadId])
  @@index([createdAt])
  @@index([newStatus])
}

model InterestedLeadNotification {
  id         Int        @id @default(autoincrement())
  replyId    Int
  reply      InboxReply @relation(fields: [replyId], references: [id], onDelete: Cascade)
  leadId     Int
  lead       Lead       @relation(fields: [leadId], references: [id], onDelete: Cascade)
  campaignId Int?
  campaign   Campaign?  @relation(fields: [campaignId], references: [id], onDelete: SetNull)

  salespersonEmail String? // Email handlowca (moÅ¼e byÄ‡ null jeÅ›li nie z kampanii)
  notifiedAt       DateTime  @default(now())
  confirmedAt      DateTime? // Kiedy handlowiec kliknÄ…Å‚ potwierdzenie
  reminderCount    Int       @default(0) // Ile razy wysÅ‚ano przypomnienie
  lastReminderAt   DateTime? // Data ostatniego przypomnienia
  status           String    @default("PENDING") // PENDING, CONFIRMED, CANCELLED

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([leadId])
  @@index([replyId])
  @@index([status])
  @@index([salespersonEmail])
}

// ============================================================================
// AUTOMATYCZNE ODPOWIEDZI Z MATERIAÅAMI
// ============================================================================

model Material {
  id         Int      @id @default(autoincrement())
  campaignId Int
  name       String // Nazwa materiaÅ‚u (np. "Katalog 2025")
  type       String // LINK | ATTACHMENT
  url        String? // URL dla LINK
  fileName   String? // Nazwa pliku dla ATTACHMENT
  order      Int      @default(0) // KolejnoÅ›Ä‡ wyÅ›wietlania (0, 1, 2, ...)
  isActive   Boolean  @default(true) // Czy aktywny
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  campaign          Campaign           @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  materialResponses MaterialResponse[]

  @@index([campaignId])
  @@index([campaignId, isActive])
}

model MaterialResponse {
  id           Int       @id @default(autoincrement())
  leadId       Int
  campaignId   Int
  replyId      Int
  materialId   Int? // NULL = wszystkie materiaÅ‚y kampanii
  subject      String
  responseText String // TreÅ›Ä‡ odpowiedzi
  aiConfidence Float? // PewnoÅ›Ä‡ AI (0.0-1.0)
  aiReasoning  String? // Uzasadnienie decyzji AI
  status       String    @default("pending") // pending | scheduled | sending | sent | failed | cancelled
  scheduledAt  DateTime? // Kiedy zaplanowano wysyÅ‚kÄ™
  sentAt       DateTime? // Kiedy faktycznie wysÅ‚ano
  error        String? // BÅ‚Ä…d jeÅ›li status = failed
  mailboxId    Int? // Z ktÃ³rej skrzynki wysÅ‚ano
  messageId    String? // ID wiadomoÅ›ci z SMTP
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  lead     Lead       @relation(fields: [leadId], references: [id], onDelete: Cascade)
  campaign Campaign   @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  reply    InboxReply @relation(fields: [replyId], references: [id], onDelete: Cascade)
  material Material?  @relation(fields: [materialId], references: [id], onDelete: SetNull)
  mailbox  Mailbox?   @relation(fields: [mailboxId], references: [id], onDelete: SetNull)

  @@index([campaignId])
  @@index([replyId])
  @@index([status])
  @@index([scheduledAt, status])
}

model PendingMaterialDecision {
  id              Int       @id @default(autoincrement())
  leadId          Int
  campaignId      Int
  replyId         Int
  aiConfidence    Float // PewnoÅ›Ä‡ AI (0.0-1.0)
  aiReasoning     String // Uzasadnienie decyzji AI
  leadResponse    String // TreÅ›Ä‡ odpowiedzi leada
  suggestedAction String // SEND | DONT_SEND
  status          String    @default("PENDING") // PENDING | APPROVED | REJECTED
  decisionNote    String? // Notatka administratora
  decidedBy       String? // Kto zdecydowaÅ‚ (np. "Administrator")
  decidedAt       DateTime? // Kiedy zdecydowano
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  lead     Lead       @relation(fields: [leadId], references: [id], onDelete: Cascade)
  campaign Campaign   @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  reply    InboxReply @relation(fields: [replyId], references: [id], onDelete: Cascade)

  @@index([campaignId])
  @@index([replyId])
  @@index([status])
}

// ============================================================================
// COMPANY SELECTION MODULE - ModuÅ‚ wyboru leadÃ³w
// ============================================================================

model CompanyImportBatch {
  id             Int      @id @default(autoincrement())
  name           String
  language       String
  market         String   @default("PL")
  totalRows      Int
  processedRows  Int      @default(0)
  importedCount  Int      @default(0)
  updatedCount   Int      @default(0)
  skippedCount   Int      @default(0)
  errorCount     Int      @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  companies Company[]

  @@index([createdAt])
}

model Company {
  id Int @id @default(autoincrement())

  // Podstawowe dane z CSV
  name                String // Nazwa firmy
  industry            String? // BranÅ¼a (np. "Targi")
  market              String?
  country             String? // Kraj (np. "Polska")
  city                String? // Miasto
  postalCode          String? // Kod pocztowy
  street              String? // Ulica
  buildingNumber      String? // Numer budynku
  website             String? // Strona www (URL)
  description         String? // Opis firmy (dÅ‚ugi tekst z CSV)
  activityDescription String? // Opis dziaÅ‚alnoÅ›ci (krÃ³tki opis)
  descriptionPl      String? // Opis w jÄ™zyku polskim (automatyczne tÅ‚umaczenie)
  activityDescriptionPl String? // Opis dziaÅ‚alnoÅ›ci po polsku
  detectedLanguage   String? // Wykryty jÄ™zyk opisu
  translationUpdatedAt DateTime? // Kiedy ostatnio przetÅ‚umaczono
  classificationClass String? // PS | WK | WKK | KK
  classificationSubClass String? // np. PS_AGENCY, WK_TRADESHOW
  classificationConfidence Float?
  classificationSource String? // RULES | AI | MANUAL
  classificationSignals String? // JSON array of matches
  classificationNeedsReview Boolean? // true jeÅ›li brak jednoznacznej klasyfikacji
  classificationUpdatedAt DateTime?

  // Dane prawne
  nip               String? // NIP
  regon             String? // REGON
  krs               String? // KRS
  legalForm         String? // Forma prawna
  establishmentDate DateTime? // Data zaÅ‚oÅ¼enia

  // Dane biznesowe
  companySize   String? // WielkoÅ›Ä‡ firmy (DuÅ¼a, Åšrednia, MaÅ‚a)
  employeeCount String? // Liczba pracownikÃ³w (zakres, np. "50-99")
  revenue       String? // Przychody (zakres, np. "20-50 mln PLN")
  netProfit     String? // Zysk netto (zakres)
  locationCount Int? // Liczba lokalizacji
  ratingPoints  Int? // Punkty oceny
  keywords      String? // Lista sÅ‚Ã³w kluczowych (CSV lub JSON)
  apolloAccountId String? // ID konta w Apollo (jeÅ›li dostÄ™pne)

  // Kody branÅ¼owe
  sicCode  String? // Kod SIC
  naceCode String? // Kod NACE

  // Import metadata
  importBatchId Int?
  importBatch   CompanyImportBatch? @relation(fields: [importBatchId], references: [id])

  // Status weryfikacji
  verificationStatus  String  @default("PENDING") // PENDING | VERIFYING | QUALIFIED | REJECTED | NEEDS_REVIEW | BLOCKED | ERROR
  verificationResult  String? // JSON z wynikiem weryfikacji AI
  verificationScore   Float? // 0.0 - 1.0 (pewnoÅ›Ä‡ AI)
  verificationReason  String? // Uzasadnienie decyzji AI
  verificationComment String? // Komentarz weryfikacji (z CSV lub rÄ™czny)

  // Progi pewnoÅ›ci (z konfiguracji)
  confidenceThreshold Float? // PrÃ³g pewnoÅ›ci uÅ¼yty do kwalifikacji

  // Metadane weryfikacji
  verifiedAt         DateTime? // Kiedy zweryfikowano
  verifiedBy         String? // "AI" | "MANUAL" | "CSV"
  verificationSource String? // "DESCRIPTION" | "WEBSITE" | "MANUAL" | "CSV"

  // Dodatkowe dane ze strony (scraping)
  scrapedContent String? // ZawartoÅ›Ä‡ ze strony (cache)
  scrapedAt      DateTime? // Kiedy pobrano zawartoÅ›Ä‡

  // Notatki uÅ¼ytkownika
  notes String?
  tags  String? // JSON array of tags
  tagScores CompanyTagScore[]

  // Dane z CSV (jeÅ›li byÅ‚y rÄ™cznie zweryfikowane)
  csvVerificationDate   DateTime? // Data weryfikacji z CSV
  csvVerificationStatus String? // Status weryfikacji z CSV (np. "Zweryfikowany")
  csvModificationDate   DateTime? // Data ostatniej modyfikacji z CSV
  csvModifiedBy         String? // UÅ¼ytkownik modyfikujÄ…cy z CSV

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  verificationLogs CompanyVerificationLog[]
  personaVerifications PersonaVerificationResult[]
  selectionMemberships CompanySelectionCompany[]

  @@index([verificationStatus])
  @@index([verifiedAt])
  @@index([industry])
  @@index([country])
  @@index([market])
  @@index([importBatchId])
}

model CompanyTagScore {
  id          Int      @id @default(autoincrement())
  companyId   Int
  tagCode     String
  score       Int
  explanation String?
  source      String   @default("AI_TAGGER")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, tagCode])
  @@index([tagCode])
}

model CompanySelection {
  id          Int      @id @default(autoincrement())
  name        String
  description String?
  market      String
  language    String? // preferowany jÄ™zyk pracy nad selekcjÄ…
  filters     String? // JSON z parametrami filtrÃ³w uÅ¼ytych do utworzenia selekcji
  totalCompanies Int   @default(0)
  activeCompanies Int  @default(0)
  createdBy   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  companies CompanySelectionCompany[]
  criteria  CompanyVerificationCriteria[]

  @@index([market])
  @@index([createdAt])
}

model CompanySelectionCompany {
  id           Int      @id @default(autoincrement())
  selectionId  Int
  companyId    Int
  status       String   @default("PENDING") // PENDING | QUALIFIED | REJECTED | NEEDS_REVIEW | BLOCKED | ERROR
  score        Float?
  reason       String?
  verifiedAt   DateTime?
  verificationResult String?
  notes        String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  selection CompanySelection @relation(fields: [selectionId], references: [id], onDelete: Cascade)
  company   Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([selectionId, companyId])
  @@index([selectionId, status])
  @@index([companyId])
}

model BlockedCompany {
  id          Int      @id @default(autoincrement())
  companyName String // Nazwa firmy do blokowania (moÅ¼e byÄ‡ czÄ™Å›ciowa)
  reason      String? // PowÃ³d blokady (opcjonalny)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   String? // Kto dodaÅ‚ (opcjonalnie)

  @@unique([companyName])
  @@index([companyName])
}

model CompanyVerificationLog {
  id        Int     @id @default(autoincrement())
  companyId Int
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // SzczegÃ³Å‚y weryfikacji
  status  String // PENDING | VERIFYING | QUALIFIED | REJECTED | NEEDS_REVIEW | ERROR
  score   Float? // 0.0 - 1.0
  reason  String? // Uzasadnienie
  source  String? // "DESCRIPTION" | "WEBSITE" | "MANUAL" | "CSV"
  content String? // TreÅ›Ä‡ uÅ¼yta do weryfikacji (opis lub zawartoÅ›Ä‡ strony)

  // AI Metadata
  aiModel  String? // "gpt-4o" | "gpt-4o-mini"
  aiTokens Int? // Liczba tokenÃ³w uÅ¼ytych
  aiCost   Float? // Szacowany koszt

  createdAt DateTime @default(now())

  @@index([companyId])
  @@index([status])
  @@index([createdAt])
}

// Konfiguracja kryteriÃ³w weryfikacji (z czatu z agentem)
model CompanyVerificationCriteria {
  id          Int     @id @default(autoincrement())
  name        String // Nazwa konfiguracji (np. "Firmy targowe - zabudowy")
  description String? // Opis kryteriÃ³w
  selectionId Int?

  // Kryteria (wygenerowane przez AI z czatu)
  criteriaText      String // PeÅ‚ny tekst kryteriÃ³w (prompt dla AI)
  qualifiedKeywords String? // JSON array - sÅ‚owa kluczowe dla QUALIFIED
  rejectedKeywords  String? // JSON array - sÅ‚owa kluczowe dla REJECTED

  // Progi pewnoÅ›ci
  qualifiedThreshold Float @default(0.8) // >= 0.8 = QUALIFIED
  rejectedThreshold  Float @default(0.3) // <= 0.3 = REJECTED
  // 0.3 < score < 0.8 = NEEDS_REVIEW

  // Historia czatu z agentem
  chatHistory     String? // JSON array - historia rozmowy z agentem
  lastUserMessage String? // Ostatnia wiadomoÅ›Ä‡ uÅ¼ytkownika
  lastAIResponse  String? // Ostatnia odpowiedÅº AI

  // Status
  isActive  Boolean @default(true)
  isDefault Boolean @default(false) // DomyÅ›lna konfiguracja

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  personaCriteria CompanyPersonaCriteria?
  selection       CompanySelection?         @relation(fields: [selectionId], references: [id], onDelete: Cascade)

  @@index([isActive])
  @@index([isDefault])
  @@index([selectionId])
}

model CompanyPersonaCriteria {
  id                Int @id @default(autoincrement())
  companyCriteriaId Int @unique
  name              String
  description       String?
  positiveRoles     String
  negativeRoles     String
  conditionalRules  String?
  language          String?
  chatHistory       String?
  lastUserMessage   String?
  lastAIResponse    String?
  createdBy         String?
  updatedBy         String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  companyCriteria     CompanyVerificationCriteria @relation(fields: [companyCriteriaId], references: [id], onDelete: Cascade)
  personaBrief        PersonaBrief?
  personaVerifications PersonaVerificationResult[]
}

model PersonaBrief {
  id                Int      @id @default(autoincrement())
  companyCriteriaId Int      @unique
  summary           String   @default("")
  decisionGuidelines String?
  targetProfiles    String?
  avoidProfiles     String?
  additionalNotes   String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  personaCriteria CompanyPersonaCriteria @relation(fields: [companyCriteriaId], references: [id], onDelete: Cascade)
}

model PersonaVerificationResult {
  id                 Int      @id @default(autoincrement())
  companyId          Int
  personaCriteriaId  Int?
  verifiedAt         DateTime @default(now())
  positiveCount      Int      @default(0)
  negativeCount      Int      @default(0)
  unknownCount       Int      @default(0)
  employees          String
  metadata           String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  company        Company               @relation(fields: [companyId], references: [id], onDelete: Cascade)
  personaCriteria CompanyPersonaCriteria? @relation(fields: [personaCriteriaId], references: [id], onDelete: SetNull)

  @@unique([companyId])
  @@index([verifiedAt])
}

model IndustrySpecializationRule {
  id                 Int      @id @default(autoincrement())
  industry           String
  specializationCode String
  score              Float    @default(5)
  explanation        String?
  source             String   @default("MANUAL") // MANUAL | AI
  status             String   @default("ACTIVE") // ACTIVE | PENDING | ARCHIVED
  createdBy          String? // email lub "AI"
  updatedBy          String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@index([industry])
  @@index([industry, specializationCode])
  @@index([status])
}

model IndustryMappingSuggestion {
  id                 Int      @id @default(autoincrement())
  industry           String
  specializationCode String
  score              Float
  explanation        String?
  evidence           String? // JSON: keywords, descriptions used by AI
  status             String   @default("PENDING") // PENDING | ACCEPTED | REJECTED
  createdBy          String? @default("AI")
  reviewedBy         String?
  reviewedAt         DateTime?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@index([industry])
  @@index([status])
}
