datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model VirtualSalesperson {
  id       Int     @id @default(autoincrement())
  name     String // np. "Marta 呕贸kowska"
  email    String  @unique // Email g贸wny (dla referencji)
  phone    String? // nr telefonu
  language String  @default("pl") // pl, en, de, fr
  markets  String? // np. "Polska, Niemcy" - rynki na kt贸re mo偶e wysya

  // G贸wna skrzynka mailowa (u偶ywana jako pierwsza w round-robin)
  mainMailboxId Int? // ID skrzynki g贸wnej
  mainMailbox   Mailbox? @relation("MainMailbox", fields: [mainMailboxId], references: [id])

  // SMTP settings - DEPRECATED (u偶ywaj Mailbox)
  smtpHost   String? // np. "bartgrafic.home.pl"
  smtpPort   Int? // np. 587
  smtpUser   String? // login SMTP
  smtpPass   String? // haso SMTP
  smtpSecure Boolean @default(false) // true = SSL (465), false = TLS (587)

  // IMAP settings - DEPRECATED (u偶ywaj Mailbox)
  imapHost   String? // np. "bartgrafic.home.pl"
  imapPort   Int? // np. 993 lub 143
  imapUser   String? // login IMAP (czsto ten sam co SMTP)
  imapPass   String? // haso IMAP (czsto to samo co SMTP)
  imapSecure Boolean @default(true) // true = SSL (993), false = TLS (143)

  // Limity wysyki - DEPRECATED (u偶ywaj Mailbox)
  dailyEmailLimit  Int       @default(150) // Max maili dziennie dla tego handlowca
  currentDailySent Int       @default(0) // Ile wysano dzisiaj
  lastResetDate    DateTime? // Kiedy ostatnio zresetowano licznik

  // Prawdziwy handlowiec (dla forwardowania zainteresowanych lead贸w)
  realSalespersonEmail     String? // Email prawdziwego handlowca
  realSalespersonName      String? // Imi i nazwisko prawdziwego handlowca
  realSalespersonPhone     String? // Telefon prawdziwego handlowca
  realSalespersonSignature String? // Podpis/tytu prawdziwego handlowca (np. "New Business Development")

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  campaigns Campaign[]
  mailboxes Mailbox[] // NOWE: Wiele skrzynek mailowych dla tego handlowca
}

model Campaign {
  id                   Int                 @id @default(autoincrement())
  name                 String
  description          String?
  subject              String? // Temat maila
  text                 String? // Tekst kampanii z ChatGPT
  jobDescription       String? // Opis stanowiska pod imieniem handlowca
  postscript           String? // PS. na kocu
  linkText             String? // Tekst wywietlany linku (np. "Visit our site: www.kreativia.eu")
  linkUrl              String? // URL docelowy (opcjonalny, jeli pusty u偶ywa linkText jako URL)
  gmailLabel           String?
  dailyLimit           Int                 @default(200)
  virtualSalespersonId Int?
  virtualSalesperson   VirtualSalesperson? @relation(fields: [virtualSalespersonId], references: [id])

  // AI Content Planner
  contentVersionId Int? // DEPRECATED - stara wersja
  contentVersion   CampaignVersion? @relation(fields: [contentVersionId], references: [id])
  savedContentId   Int? // NOWE: Z kt贸rego SavedContent pochodzi tre
  savedContent     SavedContent?    @relation(fields: [savedContentId], references: [id])

  // Harmonogram wysyki
  status             String    @default("DRAFT") // DRAFT, SCHEDULED, IN_PROGRESS, COMPLETED, PAUSED, CANCELLED
  scheduledAt        DateTime? // Kiedy wysa kampani
  sendingStartedAt   DateTime? // Kiedy faktycznie rozpoczto wysyk
  sendingCompletedAt DateTime? // Kiedy zakoczono wysyk
  delayBetweenEmails Int       @default(90) // Op贸藕nienie midzy mailami w sekundach (90s = 1.5min)
  maxEmailsPerDay    Int       @default(500) // Max maili dziennie dla kampanii

  // Ustawienia okien czasowych
  allowedDays     String  @default("MON,TUE,WED,THU,FRI") // Dni tygodnia
  startHour       Int     @default(9) // Pocztek okna (9:00)
  startMinute     Int     @default(0) // Minuty pocztku okna (0-59)
  endHour         Int     @default(15) // Koniec okna (15:00)
  endMinute       Int     @default(0) // Minuty koca okna (0-59)
  respectHolidays Boolean @default(true) // Uwzgldniaj wita
  targetCountries String? // Kraje do sprawdzania wit (np. "PL,DE,FR")

  // Follow-upy
  isFollowUp        Boolean    @default(false) // Czy to kampania follow-up
  parentCampaignId  Int? // ID kampanii nadrzdnej
  followUpSequence  Int? // Numer follow-upu (1 = pierwszy follow-up, 2 = drugi, etc.)
  followUpDays      Int        @default(7) // Po ilu dniach wysa follow-up (liczc od zakoczenia poprzedniej kampanii)
  parentCampaign    Campaign?  @relation("FollowUps", fields: [parentCampaignId], references: [id])
  followUpCampaigns Campaign[] @relation("FollowUps")

  // Kolejkowanie
  queuePriority      Int       @default(999) // Im ni偶sza liczba, tym wy偶szy priorytet (1 = najwy偶szy)
  estimatedStartDate DateTime? // Szacowana data rozpoczcia (kalkulowana)
  estimatedEndDate   DateTime? // Szacowana data zakoczenia (kalkulowana)

  // A/B Testing
  abTestEnabled Boolean @default(false) // Czy A/B test jest wczony
  abTestMode    String? // "alternating" | "random" | "hash" - metoda rozdziau wariant贸w

  // Wariant B (wariant A u偶ywa istniejcych p贸l: subject, text, jobDescription, postscript, linkText, linkUrl)
  subjectB        String? // Temat maila - wariant B
  textB           String? // Tekst kampanii - wariant B
  jobDescriptionB String? // Opis stanowiska - wariant B
  postscriptB     String? // PS. na kocu - wariant B
  linkTextB       String? // Tekst linku - wariant B
  linkUrlB        String? // URL linku - wariant B

  // Automatyczne odpowiedzi z materiaami
  autoReplyEnabled           Boolean @default(false)
  autoReplyContext           String? // Kontekst dla AI (np. "Jestemy drukarni")
  autoReplyRules             String? // JSON z reguami (co uwa偶a za prob o materiay)
  autoReplyDelayMinutes      Int     @default(15) // Op贸藕nienie przed wysaniem odpowiedzi
  autoReplyContent           String? // Statyczna tre odpowiedzi (mo偶e zawiera {firstName}, {materials})
  autoReplyGuardianTemplate  String? // Szablon informacji o opiekunie klienta (mo偶e zawiera {name}, {email}, {phone}, {title})
  autoReplyGuardianTitle     String? // Tytu opiekuna klienta (np. "New Business Development")
  autoReplyIncludeGuardian   Boolean @default(false) // Czy doda informacj o opiekunie do odpowiedzi
  autoReplyGuardianIntroText String? // Wstpny tekst przed danymi opiekuna (np. "Tw贸j opiekun klienta:")

  createdAt                DateTime                     @default(now())
  updatedAt                DateTime                     @updatedAt
  leads                    Lead[]
  sendLogs                 SendLog[]
  CampaignLead             CampaignLead[]
  CampaignEmailQueue       CampaignEmailQueue[]
  replies                  InboxReply[]
  notifications            InterestedLeadNotification[]
  materials                Material[]
  materialResponses        MaterialResponse[]
  pendingMaterialDecisions PendingMaterialDecision[]
}

model Lead {
  id              Int     @id @default(autoincrement())
  firstName       String?
  lastName        String?
  title           String?
  company         String?
  email           String  @unique
  industry        String?
  keywords        String?
  linkedinUrl     String?
  websiteUrl      String?
  companyCity     String?
  companyCountry  String?
  language        String? @default("pl") // pl, en, de, fr
  personalization String? // AI-generated or manually edited personalization
  greetingForm    String? // "Dzie dobry Panie Krystianie" - odmiana imienia

  // NEW STATUS SYSTEM
  status           String    @default("AKTYWNY") // AKTYWNY, ZAINTERESOWANY, BLOKADA, CZEKAJ, TEST
  subStatus        String? // ZAINTERESOWANY_CAMPAIGN, BLOKADA_REFUSAL, CZEKAJ_MAYBE, etc.
  blockedCampaigns String? // JSON array of campaign IDs [1,2,3]
  reactivatedAt    DateTime? // When was reactivated
  lastReactivation String? // From which status was reactivated

  // CRM MODULE
  inCRM            Boolean   @default(false) // Czy lead jest w module CRM
  crmEnteredAt     DateTime? // Kiedy lead trafi do CRM
  crmReadyForSales Boolean   @default(false) // Czy gotowy do przekazania do handlowca

  // LEAD RELATIONSHIPS AND SOURCES
  originalLeadId  Int? // ID of lead that "created" this lead (OOO, REDIRECT)
  originalLead    Lead?   @relation("LeadDerivatives", fields: [originalLeadId], references: [id])
  derivativeLeads Lead[]  @relation("LeadDerivatives")
  source          String? // CSV_IMPORT, OOO_RESPONSE, REDIRECT_RESPONSE, UNATTACHED
  sourceDetails   String? // JSON with additional information

  // DEPRECATED FIELDS (keep for backward compatibility)
  blockedReason String? // SPAM, UNSUBSCRIBE, BOUNCE, INVALID_EMAIL, MANUAL
  blockedAt     DateTime?
  isBlocked     Boolean   @default(false) // Deprecated - u偶yj status
  campaignId    Int?
  campaign      Campaign? @relation(fields: [campaignId], references: [id])

  // RELATIONS
  SendLog                  SendLog[]
  CampaignLead             CampaignLead[]
  LeadTag                  LeadTag[]
  replies                  InboxReply[]
  statusHistory            LeadStatusHistory[]
  notifications            InterestedLeadNotification[]
  materialResponses        MaterialResponse[]
  pendingMaterialDecisions PendingMaterialDecision[]
  createdAt                DateTime                     @default(now())
  updatedAt                DateTime                     @default(now()) @updatedAt
}

model SendLog {
  id            Int       @id @default(autoincrement())
  campaignId    Int? // Opcjonalne - maile testowe/warmup nie maj kampanii
  leadId        Int? // Opcjonalne - maile testowe/warmup nie maj leada
  mailboxId     Int? // NOWE: Z kt贸rej skrzynki wysano
  toEmail       String? // NOWE: Do kogo wysano mail (dla powiadomie)
  messageId     String?
  threadId      String?
  subject       String? // NOWE: Temat wysanego maila
  content       String? // NOWE: Tre wysanego maila
  variantLetter String? // "A" | "B" - kt贸ry wariant A/B zosta u偶yty (null = wariant A lub brak testu)
  status        String    @default("queued")
  error         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  campaign      Campaign? @relation(fields: [campaignId], references: [id])
  lead          Lead?     @relation(fields: [leadId], references: [id])
  mailbox       Mailbox?  @relation(fields: [mailboxId], references: [id])

  // Zapobiega wysaniu tego samego maila wiele razy do tego samego leada (race condition)
  @@index([campaignId, leadId, status])
}

model InboxReply {
  id              Int      @id @default(autoincrement())
  leadId          Int?
  campaignId      Int?
  mailboxId       Int? // NOWE: Z kt贸rej skrzynki mailowej przyszed mail
  messageId       String   @unique
  threadId        String?
  subject         String
  content         String // Pena tre odpowiedzi
  originalMessage String? // Oryginalny mail (wysany przez nas)
  fromEmail       String
  toEmail         String? // NOWE: Na kt贸r skrzynk przyszed mail
  receivedAt      DateTime

  // AI klasyfikacja
  classification  String? // INTERESTED | UNSUBSCRIBE | OOO | REDIRECT | BOUNCE | OTHER
  sentiment       String? // positive | negative | neutral
  aiSummary       String? // Kr贸tkie podsumowanie AI
  suggestedAction String? // Co zrobi dalej
  extractedEmails String? // JSON array nowych emaili (zastpcy)
  extractedData   String? // JSON z dodatkowymi danymi (imiona, OOO dates, etc)

  // Akcje wykonane przez system
  wasForwarded     Boolean   @default(false)
  forwardedAt      DateTime?
  wasBlocked       Boolean   @default(false)
  newContactsAdded Int       @default(0)

  // Status obsugi przez u偶ytkownika
  isRead      Boolean   @default(false)
  isHandled   Boolean   @default(false)
  handledAt   DateTime?
  handledNote String? // Notatka u偶ytkownika

  createdAt DateTime @default(now())

  lead                     Lead?                        @relation(fields: [leadId], references: [id])
  campaign                 Campaign?                    @relation(fields: [campaignId], references: [id])
  mailbox                  Mailbox?                     @relation(fields: [mailboxId], references: [id])
  notifications            InterestedLeadNotification[]
  materialResponses        MaterialResponse[]
  pendingMaterialDecisions PendingMaterialDecision[]

  @@index([mailboxId])
}

model CampaignLead {
  id         Int       @id @default(autoincrement())
  campaignId Int
  leadId     Int
  status     String    @default("planned") // planned | queued | sent | failed | replied
  priority   Int       @default(999) // Im ni偶sza liczba, tym wy偶szy priorytet (1 = najwy偶szy, 999 = normalny)
  sentAt     DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  campaign           Campaign             @relation(fields: [campaignId], references: [id])
  lead               Lead                 @relation(fields: [leadId], references: [id])
  campaignEmailQueue CampaignEmailQueue[]

  @@unique([campaignId, leadId])
}

model Tag {
  id          Int       @id @default(autoincrement())
  name        String    @unique
  color       String    @default("#3B82F6") // hex color
  description String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  LeadTag     LeadTag[]
}

model LeadTag {
  id        Int      @id @default(autoincrement())
  leadId    Int
  tagId     Int
  createdAt DateTime @default(now())

  lead Lead @relation(fields: [leadId], references: [id])
  tag  Tag  @relation(fields: [tagId], references: [id])

  @@unique([leadId, tagId])
}

model CompanySettings {
  id           Int     @id @default(autoincrement())
  companyName  String  @default("Kreativia")
  address      String? // Adres firmy (np. "**Showroom & Office & Production:**\nul. Bukowska 16\n62-081 Wysogotowo, PL")
  logoBase64   String? // Logo jako base64
  disclaimerPl String? // "W razie braku zainteresowania..." - Polski
  disclaimerEn String? // "In case of no interest..." - English
  disclaimerDe String? // "Bei fehlendem Interesse..." - Deutsch
  disclaimerFr String? // "En cas d'absence d'int茅r锚t..." - Fran莽ais
  legalFooter  String? // Stopka prawna
  forwardEmail String? // Email do powiadomie (forwarding zainteresowanych)

  // Ustawienia wydajnoci skrzynek (warmup & kampanie)
  warmupPerformanceSettings String? // JSON: [{week:1, warmup:15, campaign:10}, ...]
  warmupSchedule            String? // JSON: WarmupDayConfig[] - custom harmonogram warmup (30 dni)

  // Ustawienia przypomnie dla zainteresowanych
  reminderIntervalDays Int @default(3) // Ile dni midzy przypomnieniami
  maxReminderCount     Int @default(2) // Ile razy przypomnie

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Holiday {
  id          Int      @id @default(autoincrement())
  date        DateTime // Data wita
  name        String // Nazwa wita
  countryCode String // Kod kraju (PL, DE, FR, etc.)
  year        Int // Rok
  createdAt   DateTime @default(now())

  @@unique([date, countryCode])
  @@index([countryCode, year])
}

model AIRules {
  id             String   @id @default(cuid())
  classification String // INTERESTED, NOT_INTERESTED, etc.
  pattern        String? // Regex pattern
  keywords       String // JSON array of keywords
  confidence     Float // 0.0 - 1.0
  priority       Int      @default(0) // Wy偶szy = wa偶niejszy
  createdBy      String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  isActive       Boolean  @default(true)
  description    String?

  @@index([classification])
  @@index([isActive])
  @@index([priority])
}

model AIChatHistory {
  id           String   @id @default(cuid())
  userMessage  String
  aiResponse   String
  rulesCreated String? // JSON array of rule IDs
  createdAt    DateTime @default(now())
  userId       String?

  @@index([createdAt])
}

model Mailbox {
  id                   Int @id @default(autoincrement())
  virtualSalespersonId Int

  // Dane skrzynki
  email       String  @unique
  displayName String? // Opcjonalna nazwa wywietlana (jeli r贸偶na od handlowca)
  description String? // Opis skrzynki (np. "Skrzynka g贸wna", "Backup")

  // SMTP settings
  smtpHost   String
  smtpPort   Int
  smtpUser   String
  smtpPass   String // Zahaszowane haso
  smtpSecure Boolean @default(false) // true = SSL (465), false = TLS (587)

  // IMAP settings
  imapHost   String
  imapPort   Int
  imapUser   String
  imapPass   String // Zahaszowane haso
  imapSecure Boolean @default(true) // true = SSL (993), false = TLS (143)

  // Limity i status
  dailyEmailLimit  Int       @default(50) // Max maili dziennie z tej skrzynki
  currentDailySent Int       @default(0) // Ile wysano dzisiaj
  lastResetDate    DateTime? // Kiedy ostatnio zresetowano licznik
  isActive         Boolean   @default(true) // Czy skrzynka jest aktywna

  // Typ skrzynki
  mailboxType String @default("new") // new | warmed_up - czy skrzynka wymaga warmup

  // Weryfikacja skrzynki
  verificationStatus   String    @default("pending") // pending | verifying | verified | failed
  verificationError    String? // Bd weryfikacji (jeli failed)
  verificationDate     DateTime? // Kiedy zweryfikowano
  lastVerificationTest DateTime? // Ostatni test poczenia

  // Priorytet (dla round-robin)
  priority Int @default(999) // Im ni偶sza liczba, tym wy偶szy priorytet

  // Statystyki
  totalEmailsSent Int       @default(0) // czna liczba wysanych maili
  lastUsedAt      DateTime? // Kiedy ostatnio u偶yto tej skrzynki

  // ============================================================================
  // WARMUP SYSTEM - Rozgrzewanie nowych skrzynek mailowych
  // ============================================================================

  // Status warmup
  warmupStatus      String    @default("inactive") // inactive | dns_pending | ready_to_warmup | warming | ready | failed
  warmupStartDate   DateTime? // Kiedy rozpoczto warmup
  warmupDay         Int       @default(0) // Aktualny dzie warmup (1-21)
  warmupCompletedAt DateTime? // Kiedy zakoczono warmup

  // Limity warmup (stopniowo rosnce)
  warmupDailyLimit Int @default(5) // Aktualny limit warmup (5-100)
  warmupTodaySent  Int @default(0) // Ile wysano dzisiaj w warmup

  // DNS Setup Status
  dnsSetupCompleted Boolean   @default(false) // Czy skonfigurowano DNS
  mxRecordStatus    String? // pending | configured | failed
  spfRecordStatus   String? // pending | configured | failed
  dkimRecordStatus  String? // pending | configured | failed  
  dmarcRecordStatus String? // pending | configured | failed
  dnsLastCheckedAt  DateTime? // Kiedy ostatnio sprawdzono DNS

  // Deliverability metrics
  deliverabilityScore Int   @default(0) // 0-100 punkt贸w reputacji
  bounceRate          Float @default(0.0) // Procent bounce (0-100)
  openRate            Float @default(0.0) // Procent otwar (0-100)
  replyRate           Float @default(0.0) // Procent odpowiedzi (0-100)
  spamScore           Float @default(0.0) // Spam score (0-10)

  // Warmup configuration
  warmupPhase          String @default("silent") // silent | building | acceleration | ready
  warmupInternalEmails Int    @default(0) // Liczba wysanych maili wewntrznych (midzy naszymi skrzynkami)
  warmupTestEmails     Int    @default(0) // Liczba wysanych maili testowych

  // Warmup alerts and issues
  warmupIssues    String? // JSON array z problemami ["high_bounce_rate", "dns_missing"]
  lastWarmupAlert DateTime? // Ostatnie ostrze偶enie

  // NOWE: Timing warmup (dla nowego systemu kolejki)
  lastWarmupEmailAt DateTime? // Ostatni wysany mail warmup
  nextWarmupEmailAt DateTime? // Nastpny zaplanowany mail

  // Relacje
  virtualSalesperson VirtualSalesperson   @relation(fields: [virtualSalespersonId], references: [id], onDelete: Cascade)
  mainMailboxFor     VirtualSalesperson[] @relation("MainMailbox") // Skrzynki kt贸re s g贸wne dla handlowc贸w
  sendLogs           SendLog[]
  inboxReplies       InboxReply[] // Odpowiedzi otrzymane na t skrzynk
  warmupEmails       WarmupEmail[]
  warmupQueue        WarmupQueue[]
  materialResponses  MaterialResponse[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([virtualSalespersonId])
  @@index([isActive, currentDailySent])
  @@index([warmupStatus])
  @@index([dnsSetupCompleted])
}

// ============================================================================
// AI CONTENT PLANNER - Modu planowania treci kampanii
// ============================================================================

model ProductGroup {
  id             Int     @id @default(autoincrement())
  name           String // "Podwieszenia Targowe"
  description    String?
  targetAudience String? // "Wykonawcy stoisk, agencje eventowe"
  markets        String? // "PL,DE,FR" - docelowe rynki
  iconEmoji      String? @default("") // Ikona grupy
  isActive       Boolean @default(true)

  // NOWE: Chat AI na poziomie grupy (pamita wszystko o produkcie!)
  conversationHistory String? // JSON array - caa rozmowa o tym produkcie
  lastAIResponse      String? // Cache ostatniej odpowiedzi

  campaignThemes CampaignTheme[] // DEPRECATED - do usunicia
  savedContents  SavedContent[] // NOWE: Zapisane treci z rozmowy

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model CampaignTheme {
  id             Int     @id @default(autoincrement())
  productGroupId Int
  name           String // "Szybki monta偶 - 15 minut"
  description    String?

  // AI Conversation & Briefing
  conversationHistory String? // JSON array of messages
  briefingData        String? // JSON object with collected briefing
  lastAIResponse      String? // Ostatnia odpowied藕 AI (cache)

  // Briefing fields (extracted for easy access)
  targetAudience   String?
  problemStatement String?
  mainArguments    String?
  callToAction     String?
  language         String? @default("pl")
  toneOfVoice      String?
  emailLength      String? // "short" | "medium" | "long"

  // Status
  status           String @default("draft") // draft | in_briefing | ready | approved | archived
  briefingProgress Int    @default(0) // 0-100%

  // Relations
  productGroup ProductGroup      @relation(fields: [productGroupId], references: [id], onDelete: Cascade)
  versions     CampaignVersion[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([productGroupId])
  @@index([status])
}

model CampaignVersion {
  id              Int     @id @default(autoincrement())
  campaignThemeId Int
  versionNumber   Int // 1, 2, 3, 4...
  type            String // "initial" | "followup_1" | "followup_2" | "followup_3" | "followup_4"
  variantLetter   String? // "A" | "B" | "C" - dla 3 wariant贸w tego samego typu

  // Content
  subject String
  content String

  // AI Metadata
  aiRationale String? // Dlaczego AI to zaproponowa
  aiModel     String? // "gpt-4o" - jaki model u偶yto
  generatedAt DateTime @default(now())

  // User Feedback
  userFeedback String? // Twoje uwagi/komentarze
  userRating   Int? // 1-5 gwiazdek

  // Status
  status     String    @default("draft") // draft | approved | rejected | in_use
  approvedAt DateTime?
  approvedBy String? // User email/name

  // Metadata (JSON)
  metadata String? // {cta, tone, length, arguments: [...]}

  // Relations
  campaignTheme CampaignTheme @relation(fields: [campaignThemeId], references: [id], onDelete: Cascade)
  campaigns     Campaign[] // Kampanie utworzone z tej wersji

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([campaignThemeId, versionNumber, type, variantLetter])
  @@index([campaignThemeId, status])
  @@index([status])
}

// ============================================================================
// SAVED CONTENT - Zapisane treci z rozmowy z AI
// ============================================================================

model SavedContent {
  id             Int @id @default(autoincrement())
  productGroupId Int

  // Podstawowe dane
  name    String // "Szybki monta偶 v1", "Certyfikaty PL", "Follow-up monta偶"
  subject String // Temat maila
  content String // Tre maila

  // Typ i kategoria
  type     String // "initial" | "followup_1" | "followup_2" | "followup_3" | "followup_4"
  language String @default("pl") // "pl" | "en" | "de"

  // Metadata
  notes      String? // Twoje notatki/uwagi
  tags       String? // "szybki-monta偶,certyfikaty" - do filtrowania
  sourceType String  @default("manual") // "ai" | "manual" | "imported"

  // Statystyki u偶ycia
  usageCount Int       @default(0) // Ile razy u偶yto w kampaniach
  lastUsedAt DateTime?

  // Status
  isActive   Boolean @default(true)
  isFavorite Boolean @default(false) // Oznacz jako ulubiony

  // Relacje
  productGroup ProductGroup @relation(fields: [productGroupId], references: [id], onDelete: Cascade)
  campaigns    Campaign[] // Kampanie kt贸re u偶ywaj tej treci

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([productGroupId])
  @@index([type, language])
  @@index([isActive, isFavorite])
}

// ============================================================================
// AI META-AGENT - Konfiguracja zachowania AI Content Assistant
// ============================================================================

model AIPersonaConfig {
  id Int @id @default(autoincrement())

  // Historia rozmowy z meta-agentem
  configHistory   String? // JSON array [{role, content, timestamp}]
  lastUserMessage String? // Ostatnia wiadomo usera (cache)
  lastAIResponse  String? // Ostatnia odpowied藕 AI (cache)

  // Ekstraktowane zasady (parsowane przez meta-AI)
  globalRules        String? // JSON object {maxLength, tone, structure, ...}
  groupSpecificRules String? // JSON object {groupId: {rules}}

  // Wygenerowany SYSTEM_PERSONA (auto-generated przez meta-AI)
  generatedPrompt String? // Peny system prompt u偶ywany przez Content AI
  promptVersion   Int     @default(1) // Wersja promptu (inkrementowana przy zmianach)

  // Metadata
  isActive  Boolean @default(true)
  createdBy String? @default("system")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Token usage tracking
model AITokenUsage {
  id Int @id @default(autoincrement())

  // Kontekst wywoania
  operation String // np. "email_classification", "content_generation", "name_inflection"
  model     String // np. "gpt-4o", "gpt-4o-mini"

  // Tokeny
  promptTokens     Int // Tokeny wejciowe
  completionTokens Int // Tokeny wyjciowe
  totalTokens      Int // Suma

  // Estymowany koszt (w USD)
  estimatedCost Float @default(0.0)

  // Dodatkowe info
  metadata String? // JSON z dodatkowymi danymi (np. leadId, campaignId)

  createdAt DateTime @default(now())
}

// ============================================================================
// WARMUP EMAILS - Maile wysyane w ramach rozgrzewania skrzynek
// ============================================================================

model WarmupEmail {
  id        Int @id @default(autoincrement())
  mailboxId Int

  // Typ warmup maila
  type    String // internal | seed | test | campaign
  subtype String? // test_connection | internal_notification | seed_friendly | campaign_sample

  // Dane maila
  toEmail   String // Adres odbiorcy
  subject   String // Temat maila
  content   String // Tre maila
  messageId String? // ID wiadomoci (z SMTP)

  // Status wysyki
  status       String    @default("queued") // queued | sent | failed | bounced
  sentAt       DateTime? // Kiedy wysano
  errorMessage String? // Bd jeli failed

  // Tracking (tylko dla seed/campaign)
  wasOpened  Boolean   @default(false) // Czy otwarto mail
  wasReplied Boolean   @default(false) // Czy odpowiedziano
  openedAt   DateTime? // Kiedy otwarto
  repliedAt  DateTime? // Kiedy odpowiedziano

  // Warmup day info
  warmupDay   Int // Dzie warmup (1-21)
  warmupPhase String // silent | building | acceleration

  // Metadata
  metadata String? // JSON z dodatkowymi danymi

  // Relacje
  mailbox Mailbox @relation(fields: [mailboxId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([mailboxId])
  @@index([type])
  @@index([status])
  @@index([warmupDay])
}

// ============================================================================
// WARMUP QUEUE - Kolejka maili warmup (nowy system z timing)
// ============================================================================

model WarmupQueue {
  id        Int @id @default(autoincrement())
  mailboxId Int

  // Planowanie
  scheduledAt DateTime // Dokadny czas wysyki (np. 2025-10-19 07:23:00)

  // Typ maila
  emailType String // internal | seed

  // Dane maila
  toEmail String // Adres odbiorcy
  subject String // Temat maila
  body    String // Tre maila

  // Status wysyki
  status String    @default("pending") // pending | sending | sent | failed | cancelled
  sentAt DateTime? // Kiedy wysano
  error  String? // Bd jeli failed

  // Metadata
  warmupDay Int // Dzie warmup (1-30)
  metadata  String? // JSON z dodatkowymi danymi

  // Relacje
  mailbox Mailbox @relation(fields: [mailboxId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([mailboxId])
  @@index([scheduledAt, status])
  @@index([status])
}

// ============================================================================
// CAMPAIGN EMAIL QUEUE - Kolejka zaplanowanych maili kampanii (precyzyjne planowanie)
// ============================================================================

model CampaignEmailQueue {
  id             Int @id @default(autoincrement())
  campaignId     Int
  campaignLeadId Int // Relacja do CampaignLead (lead w kampanii)

  // Planowanie
  scheduledAt DateTime // Dokadny czas wysyki (np. 2025-11-04 14:31:32)

  // Status wysyki
  status String    @default("pending") // pending | sending | sent | failed | cancelled
  sentAt DateTime? // Kiedy wysano
  error  String? // Bd jeli failed

  // Metadata (opcjonalnie - dla debugowania)
  metadata String? // JSON z dodatkowymi danymi

  // Relacje
  campaign     Campaign     @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  campaignLead CampaignLead @relation(fields: [campaignLeadId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([campaignId])
  @@index([campaignLeadId])
  @@index([scheduledAt, status]) // Kluczowy indeks dla szybkiego wyszukiwania
  @@index([status])
}

model LeadStatusHistory {
  id     Int  @id @default(autoincrement())
  leadId Int
  lead   Lead @relation(fields: [leadId], references: [id], onDelete: Cascade)

  // Status change details
  oldStatus    String? // Previous status
  oldSubStatus String? // Previous sub-status
  newStatus    String // New status
  newSubStatus String? // New sub-status

  // Change reason and metadata
  reason    String? // Reason for change (e.g., "MANUAL", "AI_CLASSIFICATION", "REACTIVATION")
  changedBy String? // Who made the change (e.g., "USER", "AI", "SYSTEM")
  notes     String? // Additional notes

  // Timestamps
  createdAt DateTime @default(now())

  @@index([leadId])
  @@index([createdAt])
  @@index([newStatus])
}

model InterestedLeadNotification {
  id         Int        @id @default(autoincrement())
  replyId    Int
  reply      InboxReply @relation(fields: [replyId], references: [id], onDelete: Cascade)
  leadId     Int
  lead       Lead       @relation(fields: [leadId], references: [id], onDelete: Cascade)
  campaignId Int?
  campaign   Campaign?  @relation(fields: [campaignId], references: [id], onDelete: SetNull)

  salespersonEmail String? // Email handlowca (mo偶e by null jeli nie z kampanii)
  notifiedAt       DateTime  @default(now())
  confirmedAt      DateTime? // Kiedy handlowiec klikn potwierdzenie
  reminderCount    Int       @default(0) // Ile razy wysano przypomnienie
  lastReminderAt   DateTime? // Data ostatniego przypomnienia
  status           String    @default("PENDING") // PENDING, CONFIRMED, CANCELLED

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([leadId])
  @@index([replyId])
  @@index([status])
  @@index([salespersonEmail])
}

// ============================================================================
// AUTOMATYCZNE ODPOWIEDZI Z MATERIAAMI
// ============================================================================

model Material {
  id         Int      @id @default(autoincrement())
  campaignId Int
  name       String // Nazwa materiau (np. "Katalog 2025")
  type       String // LINK | ATTACHMENT
  url        String? // URL dla LINK
  fileName   String? // Nazwa pliku dla ATTACHMENT
  order      Int      @default(0) // Kolejno wywietlania (0, 1, 2, ...)
  isActive   Boolean  @default(true) // Czy aktywny
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  campaign          Campaign           @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  materialResponses MaterialResponse[]

  @@index([campaignId])
  @@index([campaignId, isActive])
}

model MaterialResponse {
  id           Int       @id @default(autoincrement())
  leadId       Int
  campaignId   Int
  replyId      Int
  materialId   Int? // NULL = wszystkie materiay kampanii
  subject      String
  responseText String // Tre odpowiedzi
  aiConfidence Float? // Pewno AI (0.0-1.0)
  aiReasoning  String? // Uzasadnienie decyzji AI
  status       String    @default("pending") // pending | scheduled | sending | sent | failed | cancelled
  scheduledAt  DateTime? // Kiedy zaplanowano wysyk
  sentAt       DateTime? // Kiedy faktycznie wysano
  error        String? // Bd jeli status = failed
  mailboxId    Int? // Z kt贸rej skrzynki wysano
  messageId    String? // ID wiadomoci z SMTP
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  lead     Lead       @relation(fields: [leadId], references: [id], onDelete: Cascade)
  campaign Campaign   @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  reply    InboxReply @relation(fields: [replyId], references: [id], onDelete: Cascade)
  material Material?  @relation(fields: [materialId], references: [id], onDelete: SetNull)
  mailbox  Mailbox?   @relation(fields: [mailboxId], references: [id], onDelete: SetNull)

  @@index([campaignId])
  @@index([replyId])
  @@index([status])
  @@index([scheduledAt, status])
}

model PendingMaterialDecision {
  id              Int       @id @default(autoincrement())
  leadId          Int
  campaignId      Int
  replyId         Int
  aiConfidence    Float // Pewno AI (0.0-1.0)
  aiReasoning     String // Uzasadnienie decyzji AI
  leadResponse    String // Tre odpowiedzi leada
  suggestedAction String // SEND | DONT_SEND
  status          String    @default("PENDING") // PENDING | APPROVED | REJECTED
  decisionNote    String? // Notatka administratora
  decidedBy       String? // Kto zdecydowa (np. "Administrator")
  decidedAt       DateTime? // Kiedy zdecydowano
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  lead     Lead       @relation(fields: [leadId], references: [id], onDelete: Cascade)
  campaign Campaign   @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  reply    InboxReply @relation(fields: [replyId], references: [id], onDelete: Cascade)

  @@index([campaignId])
  @@index([replyId])
  @@index([status])
}

// ============================================================================
// COMPANY SELECTION MODULE - Modu wyboru lead贸w
// ============================================================================

model CompanyImportBatch {
  id            Int      @id @default(autoincrement())
  name          String
  language      String
  market        String   @default("PL")
  totalRows     Int
  processedRows Int      @default(0)
  importedCount Int      @default(0)
  updatedCount  Int      @default(0)
  skippedCount  Int      @default(0)
  errorCount    Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  companies Company[]

  @@index([createdAt])
}

model Company {
  id Int @id @default(autoincrement())

  // Podstawowe dane z CSV
  name                      String // Nazwa firmy
  industry                  String? // Bran偶a (np. "Targi")
  market                    String?
  country                   String? // Kraj (np. "Polska")
  city                      String? // Miasto
  postalCode                String? // Kod pocztowy
  street                    String? // Ulica
  buildingNumber            String? // Numer budynku
  website                   String? // Strona www (URL)
  description               String? // Opis firmy (dugi tekst z CSV)
  activityDescription       String? // Opis dziaalnoci (kr贸tki opis)
  descriptionPl             String? // Opis w jzyku polskim (automatyczne tumaczenie)
  activityDescriptionPl     String? // Opis dziaalnoci po polsku
  detectedLanguage          String? // Wykryty jzyk opisu
  translationUpdatedAt      DateTime? // Kiedy ostatnio przetumaczono
  classificationClass       String? // PS | WK | WKK | KK
  classificationSubClass    String? // np. PS_AGENCY, WK_TRADESHOW
  classificationConfidence  Float?
  classificationSource      String? // RULES | AI | MANUAL
  classificationSignals     String? // JSON array of matches
  classificationNeedsReview Boolean? // true jeli brak jednoznacznej klasyfikacji
  classificationUpdatedAt   DateTime?

  // Dane prawne
  nip               String? // NIP
  regon             String? // REGON
  krs               String? // KRS
  legalForm         String? // Forma prawna
  establishmentDate DateTime? // Data zao偶enia

  // Dane biznesowe
  companySize     String? // Wielko firmy (Du偶a, rednia, Maa)
  employeeCount   String? // Liczba pracownik贸w (zakres, np. "50-99")
  revenue         String? // Przychody (zakres, np. "20-50 mln PLN")
  netProfit       String? // Zysk netto (zakres)
  locationCount   Int? // Liczba lokalizacji
  ratingPoints    Int? // Punkty oceny
  keywords        String? // Lista s贸w kluczowych (CSV lub JSON)
  apolloAccountId String? // ID konta w Apollo (jeli dostpne)

  // Kody bran偶owe
  sicCode  String? // Kod SIC
  naceCode String? // Kod NACE

  // Import metadata
  importBatchId Int?
  importBatch   CompanyImportBatch? @relation(fields: [importBatchId], references: [id])

  // Status weryfikacji
  verificationStatus  String  @default("PENDING") // PENDING | VERIFYING | QUALIFIED | REJECTED | NEEDS_REVIEW | BLOCKED | ERROR
  verificationResult  String? // JSON z wynikiem weryfikacji AI
  verificationScore   Float? // 0.0 - 1.0 (pewno AI)
  verificationReason  String? // Uzasadnienie decyzji AI
  verificationComment String? // Komentarz weryfikacji (z CSV lub rczny)

  // Progi pewnoci (z konfiguracji)
  confidenceThreshold Float? // Pr贸g pewnoci u偶yty do kwalifikacji

  // Metadane weryfikacji
  verifiedAt         DateTime? // Kiedy zweryfikowano
  verifiedBy         String? // "AI" | "MANUAL" | "CSV"
  verificationSource String? // "DESCRIPTION" | "WEBSITE" | "MANUAL" | "CSV"

  // Dodatkowe dane ze strony (scraping)
  scrapedContent String? // Zawarto ze strony (cache)
  scrapedAt      DateTime? // Kiedy pobrano zawarto

  // Notatki u偶ytkownika
  notes     String?
  tags      String? // JSON array of tags
  tagScores CompanyTagScore[]

  // Dane z CSV (jeli byy rcznie zweryfikowane)
  csvVerificationDate   DateTime? // Data weryfikacji z CSV
  csvVerificationStatus String? // Status weryfikacji z CSV (np. "Zweryfikowany")
  csvModificationDate   DateTime? // Data ostatniej modyfikacji z CSV
  csvModifiedBy         String? // U偶ytkownik modyfikujcy z CSV

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  verificationLogs       CompanyVerificationLog[]
  personaVerifications   PersonaVerificationResult[]
  selectionMemberships   CompanySelectionCompany[]
  classifications        CompanyClassification[]
  createdSpecializations CompanySpecialization[] // Specjalizacje utworzone przez t firm
  blockedCompanies       BlockedCompany[] // Blokady firm (dla firm bez www)

  @@index([verificationStatus])
  @@index([verifiedAt])
  @@index([industry])
  @@index([country])
  @@index([market])
  @@index([importBatchId])
  @@index([classificationSubClass])
  @@index([classificationClass])
}

model CompanyTagScore {
  id          Int      @id @default(autoincrement())
  companyId   Int
  tagCode     String
  score       Int
  explanation String?
  source      String   @default("AI_TAGGER")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, tagCode])
  @@index([tagCode])
}

model CompanyClassification {
  id                 Int      @id @default(autoincrement())
  companyId          Int
  specializationCode String
  score              Int // 1-5 scoring
  confidence         Float? // 0.0-1.0 confidence from AI
  isPrimary          Boolean  @default(false) // Main specialization
  reason             String? // AI explanation
  source             String   @default("AI") // AI | MANUAL | RULES
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, specializationCode])
  @@index([companyId])
  @@index([specializationCode])
  @@index([isPrimary])
  @@index([score])
  @@index([source])
  @@index([companyId, source]) // Zo偶ony indeks dla szybkiego deleteMany z filtrem companyId + source
}

model CompanySpecialization {
  id           Int      @id @default(autoincrement())
  code         String   @unique // np. PS_AGENCY, AI_PROMO_PRODUCER
  label        String // Nazwa specjalizacji (PL)
  description  String // Opis specjalizacji
  companyClass String // PS | WK | WKK
  createdBy    String   @default("MANUAL") // MANUAL | AI
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Jeli stworzona przez AI:
  firstCompanyId     Int? // ID pierwszej firmy, kt贸ra wymusia utworzenie tej specjalizacji
  firstCompanyName   String? // Nazwa pierwszej firmy
  firstCompanyReason String? // Pow贸d utworzenia (uzasadnienie AI)
  aiConfidence       Float? // Confidence z klasyfikacji, kt贸ra utworzya specjalizacj

  firstCompany Company? @relation(fields: [firstCompanyId], references: [id], onDelete: SetNull)

  @@index([code])
  @@index([companyClass])
  @@index([createdBy])
  @@index([createdAt])
}

model CompanySelection {
  id              Int      @id @default(autoincrement())
  name            String
  description     String?
  market          String
  language        String? // preferowany jzyk pracy nad selekcj
  filters         String? // JSON z parametrami filtr贸w u偶ytych do utworzenia selekcji
  totalCompanies  Int      @default(0)
  activeCompanies Int      @default(0)
  createdBy       String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  companies CompanySelectionCompany[]
  criteria  CompanyVerificationCriteria[]

  @@index([market])
  @@index([createdAt])
}

model CompanySelectionCompany {
  id                 Int       @id @default(autoincrement())
  selectionId        Int
  companyId          Int
  status             String    @default("PENDING") // PENDING | QUALIFIED | REJECTED | NEEDS_REVIEW | BLOCKED | ERROR
  score              Float?
  reason             String?
  verifiedAt         DateTime?
  verificationResult String?
  notes              String?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  selection CompanySelection @relation(fields: [selectionId], references: [id], onDelete: Cascade)
  company   Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([selectionId, companyId])
  @@index([selectionId, status])
  @@index([companyId])
}

model BlockedCompany {
  id          Int      @id @default(autoincrement())
  companyName String? // Nazwa firmy (tylko informacyjna, do wywietlania)
  website     String? // Adres www do blokowania (opcjonalny - null dla firm bez www)
  reason      String? // Pow贸d blokady (opcjonalny)
  blockType   String   @default("MANUAL") // MANUAL - rczna blokada, NO_WEBSITE - automatyczna blokada firm bez www
  companyId   Int?     @unique // ID firmy (dla firm bez www - jednoznaczne powizanie)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   String? // Kto doda (opcjonalnie)

  company Company? @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([website]) // Unikalno tylko dla website (nie dla null)
  @@index([website])
  @@index([companyName])
  @@index([blockType])
  @@index([companyId])
}

model CompanyVerificationLog {
  id        Int     @id @default(autoincrement())
  companyId Int
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Szczeg贸y weryfikacji
  status  String // PENDING | VERIFYING | QUALIFIED | REJECTED | NEEDS_REVIEW | ERROR
  score   Float? // 0.0 - 1.0
  reason  String? // Uzasadnienie
  source  String? // "DESCRIPTION" | "WEBSITE" | "MANUAL" | "CSV"
  content String? // Tre u偶yta do weryfikacji (opis lub zawarto strony)

  // AI Metadata
  aiModel  String? // "gpt-4o" | "gpt-4o-mini"
  aiTokens Int? // Liczba token贸w u偶ytych
  aiCost   Float? // Szacowany koszt

  createdAt DateTime @default(now())

  @@index([companyId])
  @@index([status])
  @@index([createdAt])
}

// Konfiguracja kryteri贸w weryfikacji (z czatu z agentem)
model CompanyVerificationCriteria {
  id          Int     @id @default(autoincrement())
  name        String // Nazwa konfiguracji (np. "Firmy targowe - zabudowy")
  description String? // Opis kryteri贸w
  selectionId Int?

  // Kryteria (wygenerowane przez AI z czatu)
  criteriaText      String // Peny tekst kryteri贸w (prompt dla AI)
  qualifiedKeywords String? // JSON array - sowa kluczowe dla QUALIFIED
  rejectedKeywords  String? // JSON array - sowa kluczowe dla REJECTED

  // Progi pewnoci
  qualifiedThreshold Float @default(0.8) // >= 0.8 = QUALIFIED
  rejectedThreshold  Float @default(0.3) // <= 0.3 = REJECTED
  // 0.3 < score < 0.8 = NEEDS_REVIEW

  // Historia czatu z agentem
  chatHistory     String? // JSON array - historia rozmowy z agentem
  lastUserMessage String? // Ostatnia wiadomo u偶ytkownika
  lastAIResponse  String? // Ostatnia odpowied藕 AI

  // Status
  isActive  Boolean @default(true)
  isDefault Boolean @default(false) // Domylna konfiguracja

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  personaCriteria CompanyPersonaCriteria?
  selection       CompanySelection?       @relation(fields: [selectionId], references: [id], onDelete: Cascade)

  @@index([isActive])
  @@index([isDefault])
  @@index([selectionId])
}

model CompanyPersonaCriteria {
  id                Int      @id @default(autoincrement())
  companyCriteriaId Int?     @unique
  name              String
  description       String?
  positiveRoles     String
  negativeRoles     String
  conditionalRules  String?
  language          String?
  chatHistory       String?
  lastUserMessage   String?
  lastAIResponse    String?
  createdBy         String?
  updatedBy         String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  companyCriteria        CompanyVerificationCriteria?    @relation(fields: [companyCriteriaId], references: [id], onDelete: Cascade)
  personaBrief           PersonaBrief?
  personaVerifications   PersonaVerificationResult[]
  titleVerificationCache PersonaTitleVerificationCache[] // Cache decyzji dla stanowisk

  @@index([createdAt]) // Indeks dla szybkiego sortowania po dacie utworzenia
}

model PersonaBrief {
  id                 Int      @id @default(autoincrement())
  companyCriteriaId  Int      @unique
  summary            String   @default("")
  decisionGuidelines String?
  targetProfiles     String?
  avoidProfiles      String?
  additionalNotes    String?
  aiRole             String? // Rola/perspektywa AI podczas weryfikacji (np. "ekspert od stoisk targowych", "analityk sprzeda偶owy B2B")
  positiveThreshold  Float    @default(0.5) // Pr贸g procentowy (0.0-1.0) dla klasyfikacji pozytywnej. Score >= threshold = positive, score < threshold = negative
  generatedPrompt    String? // Wygenerowany prompt do weryfikacji person przez AI (zapisany po wygenerowaniu briefu)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  personaCriteria CompanyPersonaCriteria @relation(fields: [companyCriteriaId], references: [id], onDelete: Cascade)
}

model PersonaVerificationResult {
  id                Int      @id @default(autoincrement())
  companyId         Int
  personaCriteriaId Int?
  verifiedAt        DateTime @default(now())
  positiveCount     Int      @default(0)
  negativeCount     Int      @default(0)
  unknownCount      Int      @default(0)
  employees         String
  metadata          String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  company         Company                 @relation(fields: [companyId], references: [id], onDelete: Cascade)
  personaCriteria CompanyPersonaCriteria? @relation(fields: [personaCriteriaId], references: [id], onDelete: SetNull)

  @@unique([companyId, personaCriteriaId]) // Unikalno per firma + kryteria person
  @@index([verifiedAt])
  @@index([personaCriteriaId])
}

// Cache decyzji weryfikacji AI dla stanowisk - przyspiesza weryfikacj dla powtarzajcych si stanowisk
model PersonaTitleVerificationCache {
  id                Int      @id @default(autoincrement())
  personaCriteriaId Int // Dla jakich kryteri贸w person (selekcji)
  titleNormalized   String // Znormalizowany tytu stanowiska
  titleEnglish      String  @default("") // Tytu po angielsku (pusty string zamiast null dla unique constraint)
  departments       String  @default("") // JSON array z dziaami (sorted) (pusty string zamiast null)
  seniority         String  @default("") // Poziom seniority (pusty string zamiast null)
  decision          String // "positive" | "negative" (conditional usunite)
  score             Float? // Score AI (0.0-1.0)
  reason            String? // Uzasadnienie decyzji
  verifiedAt        DateTime @default(now()) // Kiedy zostaa podjta decyzja
  useCount          Int      @default(1) // Ile razy u偶yto tego cache (statystyka)
  lastUsedAt        DateTime @default(now()) // Kiedy ostatnio u偶yto

  personaCriteria CompanyPersonaCriteria @relation(fields: [personaCriteriaId], references: [id], onDelete: Cascade)

  @@unique([personaCriteriaId, titleNormalized, titleEnglish, departments, seniority]) // Unikalno per kryteria + stanowisko
  @@index([personaCriteriaId])
  @@index([decision])
  @@index([useCount])
  @@index([lastUsedAt])
}

model IndustrySpecializationRule {
  id                 Int      @id @default(autoincrement())
  industry           String
  specializationCode String
  score              Float    @default(5)
  explanation        String?
  source             String   @default("MANUAL") // MANUAL | AI
  status             String   @default("ACTIVE") // ACTIVE | PENDING | ARCHIVED
  createdBy          String? // email lub "AI"
  updatedBy          String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@index([industry])
  @@index([industry, specializationCode])
  @@index([status])
}

model IndustryMappingSuggestion {
  id                 Int       @id @default(autoincrement())
  industry           String
  specializationCode String
  score              Float
  explanation        String?
  evidence           String? // JSON: keywords, descriptions used by AI
  status             String    @default("PENDING") // PENDING | ACCEPTED | REJECTED
  createdBy          String?   @default("AI")
  reviewedBy         String?
  reviewedAt         DateTime?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  @@index([industry])
  @@index([status])
}
